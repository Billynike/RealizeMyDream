const iL=!1,Play={init(e,n){$c("setpage",$("setting")).at(-1).ap(El("pre","about").tx(e.i)),Au.r$(()=>{Lib.spr=e._t,Lib.font=[],Lib.font.s=[],e._f.for(e=>{let[n,t,o]=e.split("-");Lib.font[0|n]=t,Lib.font.s[t]={id:t,b:0|o}}),Res.svg=0,$R=new _C.$R(e),Res.dU=()=>setTimeout(()=>$R.start(0,0,0,1).then(()=>{$("loading")._h(),ac($("box"))}),200),n()})},new(){_S=null}};$RD.then(()=>{const e=$("screen");e.get=()=>{let n=e.getBoundingClientRect();e.left=n.left,e.top=n.top},e.get();const n=UI.menu;n.ap(El("div","menu"),El("div","menu")),n.ap(El("div","cen"));let t=n.ch,o=t[2];t[0].innerHTML=UI.ico("set")+`<p>${i18n(4,0)}</p>`,t[1].innerHTML=UI.ico("web")+`<p>${i18n(5,0)}</p>`,t[0].onclick=()=>{o._s(),setTimeout(()=>css(o,{opacity:1,transform:"translate(-50%,-50%) scale(1.25)"}),17),$c("setcat",o)[0].click()},o.id="setting",o.innerHTML=`<h3>${UI.ico("set")} ${i18n(4,0)}</h3>`,o.ap(El("div","msg-cb")).onclick=()=>{css(o,{opacity:0,transform:""}),setTimeout(()=>o._h(),200)};let i=UI.BC(o,[`${i18n(6,0)}`,`${i18n(7,0)}`,`${i18n(8,0)}`,`${i18n(9,0)}`,`${i18n(10,0)}`]);i[0].ap(UI.span(`${i18n(11,0)} `),UI.B(`${i18n(12,0)}`,1).on(function(){U$.setUsername(()=>this.pS().tx(`${i18n(11,0)}`+U$.getUsername()))}),El("br"),...$C.opV(),UI.S(`${i18n(13,0)}`,1).on(e=>$R.efC=!e)),$c("rg",i[0]).for(e=>e.zoom=1.25),i[0].set=function(){this.ch[0].tx(`${i18n(11,0)}`+U$.getUsername())},i[1].id="set-ui",i[1].ap(UI.span(`${i18n(14,0)}`),UI.O("中文:zh-cn","English:en-us").on(e=>{$S.set("lang",e),e!==_lang&&UI.$q(`${i18n(15,0)}`,1).ok(e=>{location.reload()})}),UI.S(`${i18n(16,0)}`,App.gC("run","smooth")).on(e=>{App.sC("run","smooth",e);const n=$("screen");n&&(n.style.imageRendering=e?"":"pixelated")}),UI.S(`${i18n(17,0)} (F3) `).on(e=>App.setDarkMode(e,!1))),i[3].ap(Play.saveUI(1)).style.zoom=.8,i[3].set=function(){$R?.L&&this.lastChild.load()};let l=Play.onlineUI();$("box").ap(l,Play.replayUI(500)),t[1].onclick=()=>{if(!$R?.L)return;const e=()=>{UI.hideMenu(),l.firstChild.click()};$S.get("username")?e():U$.setUsername(e)}}),doc.addEventListener("keydown",e=>{if([27,114,115].includes(e.keyCode)&&(e.preventDefault(),e.stopImmediatePropagation()),!e.repeat&&!e.altKey)switch(e.keyCode){case 114:App.setDarkMode(!doc.body.className);break;case 115:$S.set("fullscreen",0|!$S.get("fullscreen")),App.initWin(),$("set-ui").set();break;case 27:UI.menu.on?UI.hideMenu():UI.showMenu()}}),Play.replayUI=e=>{let n=El("div","cm",{id:"ui-rp"}),t=El("div","rg"),o=t.ap(El("div","rgb")),i=UI.B2(UI.ico("exit")+`${i18n(18,0)}`).on(()=>n.exit());return css(o,{zIndex:1,pointerEvents:"none"}),t.style.marginRight="4px",i.style.marginLeft="8px",n.ap(UI.Play(1).on(e=>{$R.St?Play.repS():$R.pause()}),$C.opS(`${i18n(19,0)}`),t,UI.span("00:00:00"),i),n.$t=function(n,i=!0){this._t=n;let l=Math.round(Math.min(n/this.rt,1)*e);(i||Math.abs(l-this._p)>=1)&&(o.style.left=l+"px",t.style.backgroundImage=`linear-gradient(90deg,#5af ${l}px,#0000 0)`,this._p=l)},n.kb=e=>{if(!doc.igI())switch(e.keyCode){case 37:case 39:let t=e.keyCode-38,o=n.rec.id+t;for(;o>=0&&o<n.rec.length;){if(void 0!==n.rec[o].r){$R.St?Play.repS(o):$R.rep(o);break}o+=t}}},n.set=function(n,o){let i=0,l=0;n.for((e,t)=>{void 0!==e.r&&(t&&void 0===n[t-1].l&&void 0===n[t-1].f&&(l+=e.t-i),i=e.t,e._t=l),void 0!==e.l?(l+=20*e.l,i+=20*e.l):e.f?(l+=e.f-i,i=e.f):t===n.length-1&&(l+=o-i)}),this._t=0,this._p=0,this.rt=l,this.ch[3].tx(Date.cT(l/1e3<<0)),$c("on",t).for(e=>e.remove()),n.for((n,o)=>{if(void 0===n.r)return;let i=t.ap(El("div","rgb on"));i.ap(El("div","ab hcen").tx(Date.cT(n._t/1e3<<0))),i.style.left=n._t/l*e+"px",i.i=o,i.onclick=function(){$R.St?Play.repS(this.i):$R.rep(this.i)}}),this.rec=n,this._s(),$("ui-ol")._h(),doc.addEventListener("keydown",this.kb)},n.exit=function(){this._h(),$("ui-ol")._s(),doc.removeEventListener("keydown",this.kb),Play.new(),this.$s?(_S=this.$s,this.$s=null,$R.start(-1,1,0,1)):$R.start(0,0,0,1)},n._h(),n},Play.replay=async(e,n,t)=>{if($("ui-ol").on)return UI.$a(`${i18n(20,0)}`);if(!e||"-"===e)return;try{"["!==e[0]&&(e=await Ipc.zip(e,2)),e=JSON.parse(e)}catch{return UI.err(`${i18n(21,0)}`)}let o=$("ui-rp");try{o.set(e,n)}catch(e){return console.error(e),UI.err(`${i18n(22,0)}`)}$R?.notReplay&&($R.save(!1),_S&&(o.$s=_S)),o.un=t,Play.repS()},Play.repS=(e=0)=>{let n=$("ui-rp");n.firstChild.set(1),Play.new(1),n.un&&$("p-top")?.ch[0].ch[0].tx(n.un),$R.start(0,1,0,0,n.rec,e).then(()=>$R.spd=$("spd").spd??20)},Play.saveUI=e=>{let n=El("div","scroll"),t=UI.span(`${i18n(23,0)} `),o=UI.span(UI.ico("redo")+" "),i=(e,n,t)=>El("div","label ib")._c(UI.span(UI.ico(e)+n),El("span").tx(t)),l=()=>{$R.notReplay?(Play.new(),$R.start(0,0,0,1)):$("ui-rp").exit()};return Play.fin,t.aC("ib"),css(t,{fontWeight:700,lineHeight:2,marginBottom:"6px"}),o.className="cm hl",o.onclick=()=>n.load(),n.ap(t,UI.span(`${i18n(29,0)} `,"var(--clb)"),o,El("div")),t.set=()=>{t.nS()._s(),n.lastChild.innerHTML=""},n.load=()=>{let o;o=CIW.query("save","g").eq(GID),o.filter(e=>e.d).find().then(o=>{n.lastChild.innerHTML="",o.length?(t.nS()._h(),o.sort((e,n)=>(n.p??0)-(e.p??0)),o.for(t=>n.lastChild.ap((t=>{let o=UI.B2(UI.ico("trash"),"red").on(()=>{let o=t.id===$R.svI;UI.$q(o?`${i18n(25,0)}`:`${i18n(26,0)}`,e).ok(e=>CIW.del("save",t.id).then(()=>{o&&l(),n.load()}))}),r=UI.B2(UI.ico("play"),"magenta").on(()=>{e&&(UI.hideMenu(),$("ui-rp").style.opacity=1,setTimeout(()=>$("ui-rp").style.opacity="",1600)),Play.replay(JSON.stringify(t.d._r),t.d.t,U$.getUsername())}),s=UI.B2(UI.ico("change"),"cyan").on(()=>{if($R.CO())return UI.$a(`${i18n(125,0)}`,e);UI.$q(`${i18n(27,0)}`,e).ok(n=>{$R.save(!1),CIW.upd("save",t.id,e=>e.p=Date.now()).then(e=>{l(),a.set(1)},n=>UI.$a(`${i18n(28,0)}`,e))})}),a=El("div","g-d card")._c(i("label",`${i18n(114,0)}`,t.d.c?`${i18n(115,0)}`:`${i18n(116,0)}`),o,r,s,El("br"),i("date",`${i18n(30,0)}`,Date.cD(t.createdAt)),i("date",`${i18n(31,0)}`,Date.cD(t.updatedAt)),i("timer",`${i18n(32,0)}`,Date.cTm(t.d.t/1e3)),i("skull",`${i18n(33,0)}`,t.d.d));if(a.firstChild.style.width="auto",css($c("btn2",a),{float:"right",margin:"0 4px"}),t.d._r?.length||r._h(),$R.G.ACH.length){let e=i("star",`${i18n(34,0)}`,(t.d.a?.length??0)+"/"+$R.G.ACH.length);if(e.rC("ib"),e.aC("fold"),a.ap(e),t.d.a?.length){e.ap(El("span","foldp")).onclick=n=>e.hC("fold")?e.rC("fold"):e.aC("fold");let n=e.ap(El("div","ach-l flex"));t.d.a.for(e=>{let t=$R.G.ACH.find(n=>n.id===e);n.ap(El("div","ach rl ib")._c(El("div","a-cen ab n-w").tx(t.c),El("h6","n-w").tx(t.n),El("p","n-w dots cm").tx(t.d)))})}}return a.set=e=>{e?($("sv-c")?.set(0),a.id="sv-c",s._h()):(a.id="",s._s())},t.id===$R.svI&&a.set(1),a})(t)))):t.nS()._s()},e=>{t.nS()._s(),n.lastChild.innerHTML="",e?.startsWith?.("Cannot get ")||(UI.message(`${i18n(35,0)}`,`${i18n(36,0)}`,3,"#d94"),console.error(e))})},n},Play.onlineUI=()=>{const e=[{i:"Cloud I Wanna @50fps",u:"https://server.vicklleall.com"}],n=(e,n,t)=>{e.rC("pass"),e.rC("warn"),e.rC("err"),n?(e.aC("fin"),e.aC(["pass","warn","err"][n-1])):e.rC("fin"),e.tx(t)},t=t=>{let o=e[t];s.server!==o&&(s.server=o,n(u,0,`${i18n(37,0)}...`),$M.xhr("GET",o.u+"/i/","json").then(e=>{let{v:t,i:o,a:i}=e.response;i?(App.cV("0.1.0",t)?f[0].rC("on"):f[0].aC("on"),App.cV("0.2.0",t)?f[1].rC("on"):f[1].aC("on"),App.cV("0.1.0",t)?f[2].rC("on"):f[2].aC("on"),n(u,1,`${i18n(38,0)}`),s.spd=o):(f.for(e=>e.rC("on")),n(u,3,`${i18n(39,0)}`))},e=>{console.error(e.err);for(let e of f)e.rC("on");n(u,3,`${i18n(40,0)}`)}))},o=()=>{v.tx(` ${i18n(41,0)}...`),v.nS()._h(),$c("btn2",y).slice(0,-1).for(e=>e.remove()),$M.xhr("GET",s.server.u+"/i/"+s.mode+"/"+s.gid,"json",null,1e4).then(e=>{e.response.for(e=>y.prepend(UI.B2((e.n??`${i18n(42,0)}`)+" "+UI.ico("user")+e.p).on(()=>UI.$q(`${i18n(43,0)}`).ok(n=>l(e.i,e.n))))),v.tx(""),v.nS()._s()},e=>{console.error(e.err),v.tx(` ${i18n(44,0)}`),v.nS()._s()})},i=e=>{m._h(),g._s(),E.firstChild.firstChild.innerHTML=g.firstChild.innerHTML=[UI.ico("ol1")+` ${i18n(45,0)}`,UI.ico("ol2")+` ${i18n(46,0)}`,UI.ico("ol3")+` ${i18n(47,0)}`][e],s.mode=["plain","race","coop"][e],o()},l=(e,t)=>{let o=0,i=!0,l=E.firstChild.firstChild;ac(s),s.style.opacity=1,n(c,0,`${i18n(48,0)}`),d.pS().onclick(),setTimeout(()=>{m._s(),g._h()},500),t?l.ap(El("span").tx(" - "+t)):10===e.length?l.ap(El("span").tx(` - ${i18n(42,0)}`)):l.ap(El("span").tx(` - ${i18n(49,0)}`),UI.copy(e.slice(10))),E.firstChild.ch[2].innerHTML="",E._s();const a=IO(s.server.u+"/"+s.mode,{path:"/s/",rememberUpgrade:!0,reconnectionAttempts:5}),u=()=>{o&&(o=0,h.push(`${i18n(38,0)}`,"#8f8"));const e=Date.now(),n={r:s.room.id,u:U$.id+U$.getUsername()};s.room.name&&(n.rn=s.room.name),s.on=!0,s.frame=0,s.ping=Date.now(),a.emit("ctrl:join",n,n=>{(e=>{if(i&&(i=!1,css(E,{opacity:1,pointerEvents:"auto",transform:"translateY(0)"}),setTimeout(()=>css(E,{opacity:"",pointerEvents:"",transform:""}),2500),h._s(),p.placeholder=`${i18n(50,0)}`,p.style.pointerEvents="auto",p.onkeydown=e=>{e.repeat||13!==e.keyCode||(p.value&&(s.playerNum>1&&a.emit("msg",p.value),h.push(U$.getUsername()+": "+p.value),p.value=""),p.blur())},doc.addEventListener("keydown",p.kb),s.canvas||(s.canvas=new OffscreenCanvas(256,256),s.playerNameSpr={})),s.ps={},e.p.for(e=>{e.n=e.i.slice(10),s.ps[e.i.slice(0,10)]=e,delete e.i}),f(),"coop"===s.mode){let n=e.d?.s??null;s.wR=!1,s.RS=n,n?(_S={...n,t:0,d:0},$R.start(-1,1,0,0),s.sS(n.u)):$R.start(0,1,0,0)}})(n),c.update(Date.now()-e)})},f=()=>{let e,n=E.firstChild,t=n.ch[2],o=0,i=0,l=!1,r=32*(Object.keys(s.ps).length-1);t.innerHTML="",r>s.canvas.height&&(s.canvas.height=2**Math.ceil(Math.log2(r)));for(const n in s.ps){const r=s.ps[n].n;t.ap(El("div").tx(r)._c(UI.span(` (${n})`,"var(--clb)"))),n!==U$.id&&(l||(e=s.canvas.getContext("2d",{willReadFrequently:!0}),e.font="16px sy,emoji",e.textAlign="center",e.fillStyle="#fff",e.strokeStyle="#000",e.lineWidth=2.5,e.clearRect(0,0,s.canvas.width,s.canvas.height)),e.strokeText(r,128,i+16),e.fillText(r,128,i+16),s.playerNameSpr[n]=[0,i,256,32],l=!0,i+=32),o++}s.playerNum=o,l&&$R.rr.lDT(s.canvas),n.ch[1].tx(`${i18n(51,0)} `+o)};if(s.socket=a,s.room={id:e,name:t},e?a.on("connect",u):t&&a.once("connect",()=>{a.emit("ctrl:room",{g:s.gid,n:t},e=>{s.room.id=e,a.on("connect",u),u()})}),a.on("disconnect",e=>{"io server disconnect"===e||"io client disconnect"===e?r():(h.push(`${i18n(52,0)}`,"#fb8"),n(c,0,`${i18n(48,0)}`))}),a.on("connect_error",()=>{++o>=5&&(h.push(`${i18n(40,0)}`,"#f88"),n(c,3,`${i18n(53,0)}`))}),a.on("msg",e=>{h.push(s.ps[e.slice(0,10)].n+": "+e.slice(10))}),a.on("msg:join",e=>{const n=e.slice(0,10),t=e.slice(10);s.ps[n]={n:t},h.push(t+` ${i18n(54,0)}`,"#8ff"),f()}),a.on("msg:leave",e=>{h.push(s.ps[e].n+` ${i18n(55,0)}`,"#8ff"),delete s.ps[e],f()}),a.on("data:pos",e=>{const n=s.ps[e.i];n.x=e.x,n.y=e.y,n.s=e.s,n.r=e.r,$R.L[7].upd=!0}),"coop"===s.mode){s.sS=e=>h.tip(`${i18n(56,0)}`+(s.ps[e]?.n??e));let e=null;s.sT=n=>{e&&e.remove(),e=h.tip((s.ps[n]?.n??n)+` ${i18n(57,0)}`,1)},a.on("data:save",e=>{s.wR=!0,s.RS=e,s.sT(e.u)}),App.gC("net","coopTip")||new UI.M(320).p(`${i18n(118,0)}`).l(`${i18n(119,0)}`).l(`${i18n(120,0)}`).l(`${i18n(121,0)}`).b(`${i18n(122,0)}`).ok(()=>App.sC("net","coopTip",1))}},r=()=>{n(c,0,`${i18n(58,0)}`),c.aC("fin"),p.placeholder="",p.style.pointerEvents="",p.onkeydown=null,doc.removeEventListener("keydown",p.kb),E._h(),s.on=!1,s.style.opacity="","/play"!==location.pathname&&dac(s,""),"coop"===s.mode&&(Play.new(),$R.start(0,0,0,1))};let s=El("div",0,{id:"ui-ol"}),a=El("div","hover hl ib rl",{innerHTML:UI.ico("web")}),c=El("div","lint ib n-w fin").tx(`${i18n(58,0)}`),p=El("input"),d=El("div","msg-area"),h=$("screen").ap(El("div","ab",{id:"ol-msg"})._c(El("div","ab"))),u=El("div","lint"),m=d.ap(El("div")._c(UI.span(`${i18n(59,0)}`),UI.O(...e.map(e=>e.i)).on(t),u,UI.span(`${i18n(60,0)}`),El("div",0,{id:"ol-m"})._c(UI.B2(UI.ico("ol1")+`<p>${i18n(45,0)}</p>`,"cyan",1).on(()=>i(0)),UI.B2(UI.ico("ol2")+`<p>${i18n(46,0)}</p>`,"blue",1).on(()=>i(1)),UI.B2(UI.ico("ol3")+`<p>${i18n(47,0)}</p>`,"magenta",1).on(()=>i(2))))),f=m.lastChild.ch,v=El("span"),y=El("div"),I=UI.B2(UI.ico("add")+`${i18n(61,0)}`).on(()=>(new UI.M).t(`${i18n(62,0)}`).t(`${i18n(63,0)}`).ip().b(`${i18n(64,0)}`,`${i18n(1,0)}`).c$().ok(e=>l(null,e.v.slice(0,20)))),U=UI.B2(UI.ico("add")+`${i18n(65,0)}`).on(()=>{let e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",n=Date.now(),t="";for(;t.length<5;)t+=e[n%62],n=n/62|0;for(n=Math.random()*62**3|0;n;)t+=e[n%62],n=n/62|0;let o=UI.copy(t);o.addEventListener("click",e=>{let n=o.nS(2).firstChild;n.value=t,n.onchange()}),(new UI.M).t(`${i18n(66,0)}`).ap(El("p","ib").tx(`${i18n(67,0)}`),o).t(`${i18n(68,0)}`).ip("","password").b(`${i18n(65,0)}`,`${i18n(1,0)}`).ok(e=>{if(!e.v||/[^A-Za-z0-9]/g.test(e.v))return UI.$a(`${i18n(69,0)}`);l(s.gid+e.v.slice(0,20))})}),g=d.ap(El("div")._c(El("span"),El("div","fr hl back",{innerHTML:UI.ico("acc")+`${i18n(70,0)}`,onclick(){m._s(),g._h()}}),UI.p(UI.ico("see")+` ${i18n(71,0)}`,"6px 0 4px","var(--clb)")._c(v,El("span","hl",{innerHTML:UI.ico("redo"),onclick:()=>o()})),y._c(I),UI.span(UI.ico("unsee")+` ${i18n(49,0)}`,"var(--clb)"),U)),C=El("div"),E=a.ap(El("div","pointer up")._c(El("div")._c(El("div"),UI.p(UI.ico("ply")+`${i18n(51,0)}`,"8px 0 2px","var(--clb)"),C,El("div","a-cen")._c(UI.B2(`${i18n(72,0)}`,"red").on(()=>UI.$q(`${i18n(73,0)}`).ok(e=>{s.socket.disconnect(),r()}))))));return d.style.minHeight="192px",css(u,{margin:"4px 0 7px",color:"var(--clb)"}),v.style.margin="0 4px 0 6px",g._h(),css(C,{maxHeight:"160px",overflowY:"scroll",lineHeight:1.5}),E.lastChild.lastChild.style.margin="4px 0 -4px",E._h(),a.style.fontSize="20px",s.ap(a,c,p),a.onclick=()=>{if(E.style.display&&(new UI.M(400).h(`${i18n(5,0)}`).cb().ap(d),!m.style.display)){s.gid=GID;let n=App.gC("net","server");e[n]||(n=0),m.ch[1].set(n),t(n)}},s.status=c,c.update=e=>n(c,e<1e3?1:e<5e3?2:3,Math.min(e,9999)+"ms"),p.kb=e=>{doc.igI()||e.repeat||32!==e.keyCode||(e.preventDefault(),p.focus())},p.oninput=e=>{p.value=p.value.slice(0,50)},h._h(),h.time=1e4,h.push=(e,n)=>{let t=El("p").tx(e);n&&(t.style.color=n),h.firstChild.append(t),setTimeout(()=>t.style.opacity=0,h.time-1e3),setTimeout(()=>t.remove(),h.time)},h.tip=(e,n)=>{let t=El("p","ab",{style:`top:16px;${n?"righ":"lef"}t:16px`}).tx(e);return h.append(t),setTimeout(()=>t.style.opacity=0,2e3),setTimeout(()=>t.remove(),2500),t},"/play"!==location.pathname&&dac(s,""),s},window.passed&&CIW.r$(()=>{let e=$("loading");e.ch[3].onclick=()=>{e.ch[0]._s(),e.ch[1]._s(),e.ch[2].tx(""),e.ch[3].remove(),requestIdleCallback(()=>Au.init(),{timeout:2e3});let n=0,t=e=>{console.error(e.err),n=1},o=()=>UI.$a(`${i18n(74,0)}`);$M.xhr("GET",CDN+GID+"/game","json").then(e=>{const t=e.response;doc.title=t.N,Play.init(t,()=>{if(n)o();else{doc.body.ap(El("div",0,{id:"g-time"}))._h();let e=2-Res.loadNow;$R.init(o),Res.lM+=e}})},e=>{console.error(e.err),UI.$a(`${i18n(75,0)}`)}),$M.xhr("GET",CDN+GID+"/texture","blob",null,180).then(e=>{createImageBitmap(e.response).then(e=>{Res.tex=e,Res.push()})},t),$M.xhr("GET",CDN+GID+"/uv","arraybuffer",null,180).then(e=>{Res.uv=new Uint16Array(e.response),Res.push()},t)}}),$RD.then(()=>{let e=UI.menu.ch,n=$c("setpage",e[2]);n[1].ap(UI.C(`${i18n(76,0)} (F4)`,0,`${i18n(112,0)}`,`${i18n(113,0)}`).on(e=>{$S.set("fullscreen",e),window.onresize()})),n[1].set=function(){let e=this.ch;e[1].set(_lang),e[3].set(doc.body.className),e[4].set(0|$S.get("fullscreen"))},n[2].ap($C.opK()).style.zoom=.9,window.onresize=()=>{App.initWin(),$("screen").get()},doc.onwheel=null});