let $R=null,_S=null;const _C={LL:class{#t;#s;constructor(){this.#t={p:null,n:null},this.#s=this.#t}push(t){this.#s.n={p:this.#s,n:null,d:t},this.#s=this.#s.n}insert(t,s){s.p.n={p:s.p,n:s,d:t},s.p=s.p.n}remove(t){t.n?t.n.p=t.p:this.#s=t.p,t.p.n=t.n}clear(){this.#t.n=null,this.#s=this.#t}get nE(){return this.#s!==this.#t}for(t){if(this.nE){let s=this.#t.n;for(;s;)t(s.d),s=s.n}}forD(t){let s=this.#t.n;for(;s;)t(s.d,s)&&(s=s.p),s=s.n}},State:class{constructor(t){Object.assign(this,t),this._=t}$d(){let t=!1;for(let s in this._)this._[s]!==this[s]&&(this._[s]=this[s],t=!0);return t}},TC:class{init(t,s,i,e,h,r){this.T=i,this.S=i,this.I=e,this.D=h,this.F=_C.TC.F[r]??_C.TC.F[0],2!==r&&4!==r||(this.T=i/Math.PI*2),s&&(this.K=s,"function"==typeof s?(this.U=this.#i,this.E=this.#e):(this.O=t,this.U=this.#h,this.E=this.#r))}#h(){this.O[this.K]=this.F()}#i(){this.K(this.F())}#r(){this.O[this.K]=this.I+this.D}#e(){this.K(this.I+this.D)}static F=[function(){return this.I+(1-this.S/this.T)*this.D},function(){return this.I+(54.598150033144236-Math.exp(4*this.S/this.T))/53.598150033144236*this.D},function(){return this.I+Math.cos(this.S/this.T)*this.D},function(){return this.I+(1-(this.S/this.T)**2)*this.D},function(){return this.I+(1-Math.sin(this.S/this.T))*this.D},function(){return this.I+(1-this.S/this.T)**2*this.D},function(){return this.I+(1-Math.cos((1-this.S/this.T)*Math.PI))/2*this.D}];static DT=[1,4,Math.PI/2,2,Math.PI/2,2,Math.PI/2];static bT(t){const s=(t,s,i)=>(3*(s-i)+1)*t**3+(3*i-6*s)*t*t+3*s*t,i=(t,s,i)=>(9*(s-i)+3)*t*t+(6*i-12*s)*t+3*s;this.F.splice(10),t.for(t=>{const e=((t,e)=>{let h=new Array(513).fill(0),r=1/e;for(let a=1;a<e;a++){let n=0;for(;n<50;){let h=s(r,t.a,t.c)-a/e;if(Math.abs(h)<1e-15)break;r-=h/i(r,t.a,t.c),n++}h[a]=s(r,t.b,t.d),r+=1/e}return h[e]=1,h})(t,512);this.F[t.i+10]=function(){const t=512*(1-this.S/this.T),s=Math.floor(t),i=Math.ceil(t),h=e[s]+(e[i]-e[s])*(t-s);return this.I+h*this.D}})}},dSprN(t,s){t[s]<0?$R.rr.$R(t[s],this.x,this.y,-this.sprX/32,-this.sprY/32,32*this.scx,32*this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.lw[0],this.lw[1],this.lw[2]):$R.rr.$S(t[s],this.x,this.y,t.tx-this.sprX,t.ty-this.sprY,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm)},dSprB(t,s){$R.rr.BM(this.bm??this.spr.m),t[s]<0?$R.rr.$R(t[s],this.x,this.y,-this.sprX/32,-this.sprY/32,32*this.scx,32*this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.lw[0],this.lw[1],this.lw[2]):$R.rr.$S(t[s],this.x,this.y,t.tx-this.sprX,t.ty-this.sprY,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm),$R.rr.BM(0)},dHp(t,s,i,e,h,r,a,n,o,l,d,c,p,u,m){if(t>0){let c=t*(r-2*m),p=a-2*m;c>0&&p>0&&$R.rr.$R(-1,s,i,(m-r/2)/c,e/p-.5,c,p,h,d,n,o,l)}m&&$R.rr.$R(-2,s,i,-.5,e/a-.5,r,a,h,d,c,p,u,m)},moveOxy(t,s,i){let e=(s-t.sprX)*t.scx,h=(i-t.sprY)*t.scy;if(e||h)if(t.sprX=s,t.sprY=i,t.ang){let s=t.ang*Math.DR,i=Math.cos(s),r=Math.sin(s);t.x+=i*e+r*h,t.y+=-r*e+i*h}else t.x+=e,t.y+=h},cB(t,s,i,e,h,r,a,n){let o=e*t.scx,l=h*t.scy,d=t.x-o,c=t.y-l;if(t.ang){let e=t.ang*Math.DR,h=Math.cos(e),a=Math.sin(e),n=s*h,p=s*a;r[0]=d+o*(1-h)-l*a,r[1]=c+o*a+l*(1-h),r[2]=r[0]+n,r[3]=r[1]-p,r[4]=r[0]+i*a,r[5]=r[1]+i*h,r[6]=r[4]+n,r[7]=r[5]-p}else r[0]=d,r[1]=c,r[2]=d+s,r[3]=c,r[4]=d,r[5]=c+i,r[6]=r[2],r[7]=r[5];let p=0,u=1;for(let t=0;t<8;t+=2)r[t]<r[p]&&(p=t),r[t+1]<r[u]&&(u=t+1);n[0]=p,n[1]=u,n[2]=6-p,n[3]=8-u,a[0]=Math.round(r[p]),a[1]=Math.round(r[u]),a[2]=Math.round(r[6-p]),a[3]=Math.round(r[8-u])},skip(){},ST(t,s,i=!1,e=!0){t.upd&&(t.upd=!1,e&&t.setAttribute("style",""),s._&&!i||(s._={},s.for(t=>Lib.act[6][Math.round(100*t[0]%100-1)](s._,t))),css(t,s._))},cE(t){t?.for(t=>_C.cA[t[0]]?.(t))},cA:{.01(t){t[1]?.length&&(2===t[1][0]?t[2]=[34,[0,t[1][1],t[1][2]]]:t[2]=t[1][1],t[1]=+(1===t[1][0]))},4.28(t){t[1]?.length&&(t[7]=t[1][1],t[8]=t[1][3],t[1]=t[1][2])},5.02(t){"number"==typeof t[2]&&(t[3].unshift([6.42,t[2]]),t[2]=t[3],t.length=3),_C.cE(t[2])},6.05(t){3===t.length&&(t[2]!==t[1]&&(t[1]=[0,t[1],t[2]]),t.splice(2))},6.21(t){t[1]?.length&&(t[3]=t[1][1]===t[1][2]?t[1][1]:[0,t[1][1],t[1][2]],t[2]=t[1][0]+1,t[1]=0)},6.23(t){2===t.length&&(t[2]=t[1][1],t[1]=t[1][0])},6.25(t){3===t.length&&(t[2]!==t[1]&&(t[1]=[0,t[1],t[2]]),t.splice(2))},6.27(t){5===t.length&&(t[1]=t[1]===t[2]?t[1]:[0,t[1],t[2]],t[2]=t[3]===t[4]?t[3]:[0,t[3],t[4]],t.splice(3))},6.39(t){2===t.length&&(t[2]=1===t[1][0]?[0,t[1][1],t[1][2]]:t[1][1],t[1]=t[1][0])},6.41(t){4===t.length&&(t[2]!==t[3]&&(t[2]=[0,t[2],t[3]]),t.splice(3))},6.5(t){3===t.length&&(t[3]=0,t[4]=-t[2],t[5]=t[2],t[6]=-t[2],t[7]=t[2],t[2]=t[1])},6.53(t){3===t.length&&(t[3]=t[2][0],t[4]=t[2][1],t[2]=t[1][1],t[1]=t[1][0])},3.12(t){_C.cE(t[2]),_C.cE(t[3])},3.13(t){_C.cE(t[2]),_C.cE(t[3])},3.14(t){_C.cE(t[3]),_C.cE(t[4])},3.15(t){_C.cE(t[2]),_C.cE(t[3])},5.03(t){_C.cE(t[2]),_C.cE(t[3])}},WR:class{#a;constructor(t,s,i){this.canvas=t,this.w=s,this.h=i,this.#a=[],this.cM=new Float32Array(8),this.dC=!1,this.dO=!1,this.GUI=0,this.L=65536}addSpr(t){t[0]&&this.#a.push(t)}textureMap(t){let s=Res.tex;t.push(...Res.uv),delete Res.uv,delete Res.tex;let i=t.length/4;return this.#a.for(s=>{if(s.j||s.k){let e=t[4*s[0]],h=t[4*s[0]+1],r=t[4*s[0]+2],a=t[4*s[0]+3],n=-s.j||0,o=-s.k||0,l=n,d=o;for(;l%r||d%a;)t.push(e+(l%r+r)%r,h+(d%a+a)%a,r,a),s.push(i++),l+=n,d+=o}}),this.#a.length=0,s}vC(t,s){t===this.cM[4]&&s===this.cM[5]||(this.cM[4]=t,this.cM[5]=s,this.dC=!0)}vT(t,s,i){if(i){const e=i*Math.DR,h=Math.cos(e),r=Math.sin(e);this.cM[0]=h*t/400,this.cM[1]=r*t/400,this.cM[2]=r*s/304,this.cM[3]=h*s/-304}else this.cM[0]=t/400,this.cM[1]=0,this.cM[2]=0,this.cM[3]=s/-304;this.cM[6]=Math.min(t,s),this.cM[7]=i,this.dC=!0}}};_C.WL=class extends _C.WR{#n;#o;#l;#d;#c;#p;#u;#m;#f;#y=16;#v;#g;#b;#x=-1;#w;constructor(t,s,i,e){super(t,s,i),t.addEventListener("webglcontextcreationerror",t=>{t.statusMessage&&console.error(t.statusMessage)}),t.addEventListener("webglcontextlost",t=>{t.statusMessage&&console.error(t.statusMessage),UI.$a(`${i18n(84,0)}`)}),t.addEventListener("webglcontextrestored",t=>{this.#o=null,this.#R()}),this.#n=e,this.#b=[]}#M(t,s){const i=this.#o,e=i.createShader(t);if(i.shaderSource(e,s),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS))throw i.getShaderInfoLog(e);return e}#B(t){const s=this.#o,i=s.createTexture(),e=s.getExtension("EXT_texture_filter_anisotropic"),h=s.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT);return s.activeTexture(s.TEXTURE0+t),s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST_MIPMAP_LINEAR),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAX_LEVEL,2),s.texParameteri(s.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(16,h)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),i}#_(t,s){const i=this.#o;i.activeTexture(i.TEXTURE0+t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA8,s.width,s.height,0,i.RGBA,i.UNSIGNED_BYTE,s),i.generateMipmap(i.TEXTURE_2D)}lDT(t){this.#_(1,t)}#R(){if(this.#o)return this.#_(0,this.#v);this.#o=this.canvas.getContext("webgl2",{depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:this.#n,failIfMajorPerformanceCaveat:!0});const t=this.#o;if(!t)throw"Failed to get WebGL context";t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA);const s=this.#M(t.VERTEX_SHADER,_C.WL.VertGLSL),i=this.#M(t.FRAGMENT_SHADER,_C.WL.FragGLSL),e=t.createProgram();if(t.attachShader(e,s),t.attachShader(e,i),t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS))throw t.getProgramInfoLog(e);t.useProgram(e);const h=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,h),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,3]),t.STATIC_DRAW),this.#c=t.getUniformLocation(e,"camera"),t.uniform1i(t.getUniformLocation(e,"sttSpr"),0),t.uniform1i(t.getUniformLocation(e,"dynSpr"),1),t.hint(t.GENERATE_MIPMAP_HINT,t.NICEST),this.#B(0),this.#_(0,this.#v),this.#B(1),this.#u=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#u),t.bufferData(t.ARRAY_BUFFER,this.#p,t.DYNAMIC_DRAW),this.#w=[],["spr","pos","trans","blend"].for((s,i)=>{const h=t.getAttribLocation(e,s);t.vertexAttribPointer(h,4,t.FLOAT,!1,4*this.#y,16*i),t.vertexAttribDivisor(h,1),t.enableVertexAttribArray(h),this.#w[i]=h}),this.#w.offset=0}async init(){this.vT(1,1,0),this.#g=[],this.#v=this.textureMap(this.#g),this.#p??=new Float32Array(this.#y*this.L),this.#m=this.#f=0,this.#R()}BM(t){const s=this.#b[this.#x];if(s?.m!==t)if(s?.i===this.#m){let i=this.#b[this.#x-1];i?.m===t?this.#x--:s.m=t}else{this.#x++;let s=this.#b[this.#x];s?(s.m=t,s.i=this.#m):this.#b.push({m:t,i:this.#m})}}$S(t,s,i,e,h,r=1,a=1,n=0,o=1,l=1,d=1,c=1,p=0){if(this.#m>=this.L)return;const u=this.#m++*this.#y,m=this.#p,f=this.#g,y=4*t;m[u]=f[y],m[u+1]=f[y+1],m[u+2]=f[y+2],m[u+3]=f[y+3],m[u+4]=s,m[u+5]=i,m[u+6]=e,m[u+7]=h,m[u+8]=r,m[u+9]=a,m[u+10]=n,m[u+11]=this.GUI+(p<<1),m[u+12]=l,m[u+13]=d,m[u+14]=c,m[u+15]=o}$E(t,s,i,e,h,r,a,n,o,l=1,d=1,c=0,p=1,u=1,m=1,f=1,y=0){if(this.#m>=this.L)return;const v=this.#m++*this.#y,g=this.#p,b=this.#g,x=4*t;g[v]=b[x]+s,g[v+1]=b[x+1]+i,g[v+2]=e,g[v+3]=h,g[v+4]=r,g[v+5]=a,g[v+6]=n,g[v+7]=o,g[v+8]=l,g[v+9]=d,g[v+10]=c,g[v+11]=this.GUI+(y<<1),g[v+12]=u,g[v+13]=m,g[v+14]=f,g[v+15]=p}$R(t,s,i,e,h,r,a,n,o,l,d,c,p=1,u=1,m=1){if(this.#m>=this.L)return;const f=this.#m++*this.#y,y=this.#p;y[f]=t,y[f+1]=p,y[f+2]=u,y[f+3]=m,y[f+4]=s,y[f+5]=i,y[f+6]=e,y[f+7]=h,y[f+8]=r,y[f+9]=a,y[f+10]=n,y[f+11]=this.GUI,y[f+12]=l,y[f+13]=d,y[f+14]=c,y[f+15]=o}drawDynamicSpr(t,s,i,e,h,r,a,n,o=1,l=1,d=0,c=1,p=1,u=1,m=1){if(this.#m>=this.L)return;const f=this.#m++*this.#y,y=this.#p;y[f]=t,y[f+1]=s,y[f+2]=i,y[f+3]=e,y[f+4]=h,y[f+5]=r,y[f+6]=a,y[f+7]=n,y[f+8]=o,y[f+9]=l,y[f+10]=d,y[f+11]=this.GUI+4,y[f+12]=p,y[f+13]=u,y[f+14]=m,y[f+15]=c}free(){const t=this.#o;t&&!t.isContextLost()&&t.clear(t.COLOR_BUFFER_BIT),this.dC=!1,this.dO=!1}updO(){this.dO=!0,this.#x=-1,this.#b.length=0}#C=0;#k(t){const s=this.#o;switch(t<10&&this.#C>=10&&s.blendEquation(s.FUNC_ADD),t){case 0:s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA);break;case 3:s.blendFunc(s.ONE_MINUS_DST_ALPHA,s.ONE);break;case 1:s.blendFunc(s.ONE,s.ONE);break;case 2:s.blendFuncSeparate(s.DST_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ZERO,s.ONE);break;default:let i=$R.bm[t];i&&(s.blendFuncSeparate(i.cs,i.cd,i.as,i.ad),s.blendEquationSeparate(i.cf,i.af),i.cc&&s.blendColor(i.r,i.g,i.b,i.ac))}this.#C=t}render(){const t=this.#o;if(t.isContextLost())return;this.dC&&(t.uniformMatrix4x2fv(this.#c,!1,this.cM),this.dC=!1),this.dO&&(this.#f=this.#m,this.#m&&t.bufferSubData(t.ARRAY_BUFFER,0,this.#p.subarray(0,this.#f*this.#y)),this.#m=0,this.dO=!1);let s=0;this.#b[0]?.m===this.#C&&(s=1),this.#b[s]?.i&&this.#C&&this.#k(0),t.clear(t.COLOR_BUFFER_BIT);for(let i=0;i<this.#f;){let e=this.#f-i;s<this.#b.length&&(e=this.#b[s].i-i),this.#w.offset!==i&&(this.#w.for((s,e)=>{const h=4*this.#y;t.vertexAttribPointer(s,4,t.FLOAT,!1,h,h*i+16*e)}),this.#w.offset=i),t.drawElementsInstanced(t.TRIANGLE_STRIP,4,t.UNSIGNED_BYTE,0,e),s<this.#b.length&&this.#k(this.#b[s++].m),i+=e}}static VertGLSL="#version 300 es\nvec2 v[4]=vec2[4](vec2(0),vec2(1,0),vec2(0,1),vec2(1));mat2 m=mat2(vec2(.0025,0),vec2(0,-1./304.));uniform highp mat4x2 camera;in vec4 spr,pos,trans,blend;out mediump vec4 param;out vec4 uv;out mediump vec4 color;void main(){param.x=float(spr.x<0.)*spr.x+float(int(trans.w)>>1);param.y=spr.y;param.z=spr.z*.5;float c=radians(trans.z),t=cos(c),p,s,o,i;c=sin(c);p=float(int(trans.w)&1);s=1.-p;o=float(spr.x<0.);i=1.-o;vec2 x=v[gl_VertexID]*(i*spr.zw+o*vec2(1));gl_Position=vec4(((x+pos.zw)*mat2(vec2(t*trans.x,c*trans.y),vec2(-c*trans.x,t*trans.y))+pos.xy-s*camera[2]-p*vec2(400,304))*(s*mat2(camera[0],camera[1])+p*m),0,1);uv=vec4(x+i*spr.xy-o*.5,trans);color=blend;}";static FragGLSL="#version 300 es\nprecision mediump float;uniform highp mat4x2 camera;uniform sampler2D sttSpr,dynSpr;in mediump vec4 param;in highp vec4 uv;in vec4 color;out vec4 fragColor;float s(float y,float u,float s){return clamp((s-y)/(u-y),0.,1.);}float s(vec2 v,vec2 m){if(m.x==m.y)return length(v)-m.x;v=abs(v);if(v.x>v.y)v=v.yx,m=m.yx;float u=m.y*m.y-m.x*m.x,y=m.x*v.x/u,r=m.y*v.y/u,s=y*y,x=r*r,p=(s+x-1.)/3.,c=p*p*p,f=s*x,a=c+f,b,i,k;f+=a;b=y+y*x;if(a<0.){float v=acos(min(f/c,1.))/3.,a=cos(v)+2.,y=sin(v)*1.73205080756888,r=sqrt(s-p*(a+y));v=sqrt(s-p*(a-y));i=v+sign(u)*r+abs(b)/(r*v);}else{float v=2.*y*r*sqrt(a),m=sign(f+v)*pow(abs(f+v),.333333333333333),x=sign(f-v)*pow(abs(f-v),.333333333333333),u=-m-x-p*4.+2.*s;m=(m-x)*1.73205080756888;v=sqrt(u*u+m*m);i=m/sqrt(v-u)+2.*b/v;}i=(i-y)/2.;k=sqrt(max(1.-i*i,0.));m*=vec2(i,k);return length(m-v)*sign(v.y-m.y);}void main(){switch(int(param.x)){case 0:case 1:{vec2 v=vec2(textureSize(sttSpr,0)),u=uv.xy/v,y=clamp(abs(uv.zw)*camera[3].x-.75,0.,.5),r=fract(uv.xy);vec4 m=textureGrad(sttSpr,(floor(uv.xy)+min(r,.5-y)+max(r-.5,y))/v,dFdx(u)/1.5,dFdy(u)/1.5);fragColor=color*vec4((1.-param.x)*m.xyz+param.x*m.w,m.w);break;}case 2:fragColor=texture(dynSpr,uv.xy/vec2(textureSize(dynSpr,0)))*color;break;case -1:fragColor=color;break;case -2:{fragColor=abs(uv.z)-param.y*2.<=0.||abs(uv.w)-param.y*2.<=0.?color:color*float(abs(uv.x)>.5-param.y/uv.z||abs(uv.y)>.5-param.y/uv.w);break;}case -3:case -4:{float v=param.y/2.,r=.25/camera[3].x,y;vec2 u=uv.xy*uv.zw,x=vec2(abs(uv.z)/2.-r-v,abs(uv.w)/2.-r-v);y=abs(s(u,x));fragColor=color*(float(param.x==-3.)*min(s(r*2.,0.,y)+float(length(u/x)<1.),1.)+float(param.x==-4.)*s(v+r,v-r,y));break;}case -5:case -6:{float v=param.y*param.z,y=length(uv.xy);v=clamp(smoothstep(v,param.z,y)*.75+s(v,param.z,y)*.25,0.,1.);fragColor=color*(float(param.x==-5.)*(1.-v)+float(param.x==-6.)*v);break;}case -7:fragColor=color*min((uv.y+.5)/param.y,(.5-uv.y)/(1.-param.y));break;}fragColor.xyz*=color.w;}"},_C.dec={rStr:"",setFlag(t){let s=(t??"").padEnd(6,"-|(~");this.bias=s.charCodeAt(0),this.iObj=s[1],this.iLay=s[2],this.iStr=s[3],this.iArr=s[4],this.iPro=s[5]},set(t,s,i=null){this.code=t,this.lib=i??Lib.obj,this.p=0,this.setFlag(s)},n(){return this.code.charCodeAt(this.p++)-this.bias},k(){let t="",s=this.n();if(s<0)throw"decode key "+s;for(;s;)t+=String.fromCharCode(s%32+96),s>>=5;return t},N(){let t=this.n();if(t>6e4){let s=t-60001;return t=Number(this.code.slice(this.p,this.p+s)),this.p+=s,t}let s=t/1e4<<0,i=s<3?1:-1;for(t%=1e4;s%3;)i*=10,s--;return t/i},s(){this.p++;let t="";for(;this.code[this.p]!==this.iStr;)if(t+=this.code[this.p++].replace(this.rStr,this.iStr),this.p>=this.code.length)throw"decode str at pos "+this.p;return this.p++,t},a(t){this.p++;const s=[];let i=this.n();for(t&&(s.p=this.p);i--;)if(s.push(this.v(t)),this.p>=this.code.length)throw"decode arr at pos "+this.p;return s},v(t){switch(this.code[this.p]){case this.iStr:return this.s();case this.iArr:return this.a(t);default:return this.N()}},o(t,s=!0,i=null){let e=this.lib[t];if(e?(e={...e},e.add=s?$M.cp(e.add):{...e.add}):e={add:{}},e.cid=t,this.code[this.p]===this.iPro){for(this.p++;this.code[this.p]!==this.iPro;){const t=this.k();if("￿"===this.code[this.p]?(delete e.add[t],this.p++):(i&&(i[t]=this.p),e.add[t]=this.v(i)),this.p>=this.code.length)throw"decode pro at pos "+this.p}this.p++}return e},r(t,s,i=!0,e=!1){let h=0;for(t(h);this.p<this.code.length;){const r=this.code[this.p++];if(r===this.iObj){let t=this.n();for(;this.p<this.code.length&&this.code[this.p]!==this.iObj&&this.code[this.p]!==this.iLay;){const r={start:this.p};r.x=this.N(),r.y=this.N(),e&&(r.map={}),r.prop=this.o(t,i,r.map),r.prop.add.dep=h,r.end=this.p,s(r)}}else r===this.iLay&&t(++h)}}},_C.L=class{constructor(t){this.i=t,this.o=[],this.a=[],this.e=new _C.LL,this.draw=t<11?this.#S:this.#T,this.oCC=0}push(t){return this.o.push(t)-1}add(t){t.$d(),this.a.push(t)}clear(){this.oCC=0,this.o.length=0,$R._r.ptc?this.e.nE&&this.e.forD((t,s)=>{if(t.ptc!==$R._r.ptc)return this.e.remove(s),!0}):this.e.clear(),this.ready=!1}init(){this.a.length=0,this.ready=!0,10===this.i&&($R._r.gui?this.draw=this.#T:this.draw=this.#S)}iG(){return this.draw===this.#T}iter(t){this.oCC=0;for(let s=0;s<this.a.length;s++)this.a[s]._des||t(this.a[s])}gc(){let t=this.o.length-1,s=0,i=0;for(let e=this.a.length;e--;)if(this.a[e]._des){s=e,i++;let h=this.a[e].oid;h<t&&(this.o[h]=this.o[t],this.o[h].oid=h),t--}else i&&(this.a.splice(s,i),i=0);i&&this.a.splice(s,i),t+1<this.o.length&&(this.o.length=t+1),this.e.nE&&(this.upd=!0,this.e.forD((t,s)=>t.move(s)))}#S(){if(this.i===$R._r.dbg&&this.#O(),7===this.i){if($R.OL?.on){const t=$R.OL.ps;for(const s in t)if(s!==U$.id&&t[s].r===$R._r.id){const i=t[s],e=i.s,h=64&e,r=$R.OL.playerNameSpr[s];let a=1,n=1;if($R.$p){let t=Math.max(0,Math.abs($R.$p.x-i.x)-12),s=Math.max(0,Math.abs($R.$p.y-i.y)-16);a=Math.min(1,Math.dis(t,s)/16),t=Math.max(0,t-4),s=Math.max(0,Math.abs($R.$p.y-(i.y-28))-8),n=Math.min(1,Math.dis(t,s)/24)}const o=$R._r.Spr[["ply_i","ply_r","ply_j","ply_f","ply_t","ply_b"][7&e]],l=8&e?-1:1,d=1;_C.Y.dPl(i.x,i.y,270-90*((48&e)>>4),o,$R.OL.frame/5%o.length<<0,.6*a,h,l,d,[1,1,1],0),r&&$R.rr.drawDynamicSpr(r[0],r[1],r[2],r[3],i.x,i.y-24*Math.max(1,d),-128,-16,1,1,0,.8*n)}}$R.$p&&$R.$p.draw();const t=$R.Col.c[1].o;for(let s=0;s<t.length;s++)t[s].draw()}if(this.e.for(t=>t.draw()),7===this.i){const t=$R.Col.c[2].o;for(let s=0;s<t.length;s++)t[s].draw()}for(let t=0;t<this.a.length;t++)this.a[t].draw();this.upd=!1}#O(t=!1){const s=$R._r.bg;if(s.m<3){this.i&&$R.rr.BM(3);let t=s.c.w,i=s.c.h;switch(s.m){case 0:t*=s.sx,i*=s.sy;let e=$R.view,h=Math.snap(e.L-$R.bgX,t)+$R.bgX,r=Math.snap(e.T-$R.bgY,i)+$R.bgY,a=h;for($R.dBgL=h,$R.dBgT=r;r<e.B;r+=i)for(h=a;h<e.R;h+=t)$R.rr.$S(s.c[0],h,r,0,0,s.sx,s.sy);$R.dBgR=h,$R.dBgB=r;break;case 1:t*=s.sx,i*=s.sy,$R.rr.GUI=1;let n=400-(t>>1),o=304-(i>>1),l=0,d=0,c=800,p=608;for($R.bgA%180&&(l=-103,d=-199,c=903,p=807);n>l;)n-=t;for(;o>d;)o-=i;for(;o<p;o+=i)for(let i=n;i<c;i+=t)$R.rr.$S(s.c[0],400,304,(i-400)/s.sx,(o-304)/s.sy,s.sx,s.sy,$R.bgA);$R.rr.GUI=0;break;case 2:$R.rr.$S(s.c[0],0,0,0,0,$R._r.w/t,$R._r.h/i)}this.i&&$R.rr.BM(0)}else 3!==s.m||t||(this.i&&$R.rr.BM(3),$R.rr.GUI=1,$R.rr.$R(-1,0,0,0,0,800,608,0,1,...s.rgb),$R.rr.GUI=0,this.i&&$R.rr.BM(0))}#T(){this.i===$R._r.dbg&&this.#O(),$R.rr.GUI=1,this.e.for(t=>t.draw()),11===this.i&&$R.flA>0&&$R.rr.$R(-1,0,0,0,0,800,608,0,$R.flA,...$R.flC);for(let t=0;t<this.a.length;t++)this.a[t].draw();$R.rr.GUI=0,void 0===$R._r.dbg&&this.#O(!0),this.upd=!1}},_C.View=class{constructor(){this.w=800,this.h=608,this.w2=400,this.h2=304,this.pS=NaN,this.pA=NaN}init(){const t=$R._r;switch(this.s=1,this.a=0,this.x=400,this.y=304,this.dX=0,this.dY=0,this.mW=0,this.mH=0,this.sM=t.vSm??10,this.O=null,this.sO=null,this.aO=null,t.vM){case 1:this.fW=t.w,this.fH=t.h;break;case 2:this.fW=Math.min(t.vW,t.w-2*t.vMW),this.fH=Math.min(t.vH,t.h-2*t.vMH),this.s=t.vS,this.mW=t.vMW,this.mH=t.vMH;break;default:this.fW=800,this.fH=608}this.fO=$R.$p,this.sX=0,this.sY=0,this.dDX=0,this.dDY=0,this.sT=0,this.aT=0}update(t=!1){this.sO?this.s=Math.mM(this.sO.scx,.1,2):this.sT&&(this.sT--,this.s+=this.sD),this.aO?this.a=this.aO.ang:this.aT&&(this.aT--,this.a+=this.aD);let s,i,e,h,r=this.w2*this.s,a=this.h2*this.s;if(this.fO?this.fO._des?this.fO=null:(this.fX=this.fO.x,this.fY=this.fO.y):t&&(this.fX=r,this.fY=a),this.O)this.x=this.O.x,this.y=this.O.y,s=Infinity,i=Infinity,e=-Infinity,h=-Infinity;else{let n,o,l,d,c=Math.min(this.fW/2,r),p=Math.min(this.fH/2,a),u=Math.mM(this.fX,this.mW,$R._r.w-this.mW-1e-7),m=Math.mM(this.fY,this.mH,$R._r.h-this.mH-1e-7);if(s=Math.snap(u-this.mW,this.fW)+this.mW,i=Math.snap(m-this.mH,this.fH)+this.mH,e=Math.min(s+this.fW,$R._r.w-this.mW),h=Math.min(i+this.fH,$R._r.h-this.mH),s+c>e-c?(o=n=(s+e)/2,s=n-c,e=n+c):(n=s+c,o=e-c),i+p>h-p?(d=l=(i+h)/2,i=l-p,h=l+p):(l=i+p,d=h-p),u=Math.mM(this.fX,n,o),m=Math.mM(this.fY,l,d),t||0===this.sM)this.x=u,this.y=m;else{let t=Math.max(1,Math.exp(this.s-1)*this.sM);this.x+=(u-this.x)/t,this.y+=(m-this.y)/t,this.x=Math.mM(this.x,n,o),this.y=Math.mM(this.y,l,d)}}if($R.G.v<10?(this.sX>0||this.sY>0)&&(this.dX=Math.rand(-this.sX,this.sX),this.dY=Math.rand(-this.sY,this.sY),this.sX-=this.dDX,this.sY-=this.dDY):(this.sX>0&&(this.dX=Math.rand(-this.sX,this.sX),this.sX-=this.dDX),this.sY>0&&(this.dY=Math.rand(-this.sY,this.sY),this.sY-=this.dDY)),this.s<1?(this.cameraX=this.x+this.dX,this.cameraY=this.y+this.dY):(this.cameraX=Math.round(this.x+this.dX),this.cameraY=Math.round(this.y+this.dY)),this.pS!==this.s||this.pA!==this.a){let t=this.a*Math.DR,s=Math.cos(t),i=Math.sin(t),e=s*r+i*a,h=s*a-i*r,n=s*r-i*a,o=s*a+i*r;this.rH=Math.max(Math.abs(e),Math.abs(n)),this.rV=Math.max(Math.abs(h),Math.abs(o)),this.pS=this.s,this.pA=this.a}if(this.L=this.cameraX-this.rH,this.T=this.cameraY-this.rV,this.R=this.cameraX+this.rH,this.B=this.cameraY+this.rV,t||this.L-16<this.AL||this.T-16<this.AT||this.R+16>this.AR||this.B+16>this.AB)return this.AL=this.L<s-16?this.L-192:Math.max(s-32,this.L-192),this.AT=this.T<i-16?this.T-192:Math.max(i-32,this.T-192),this.AR=this.R>e+16?this.R+192:Math.min(e+32,this.R+192),this.AB=this.B>h+16?this.B+192:Math.min(h+32,this.B+192),!0}guiXY(t,s){let i=this.a*Math.DR,e=Math.cos(i),h=Math.sin(i),r=(t-400)*this.s,a=(s-304)*this.s;return[this.cameraX+e*r+h*a,this.cameraY+e*a-h*r]}},_C.$R=class{static rS;static#L;static#D;static#I;static#A;static#G;static#j;static#E(t=!1){if(this.#L)return;const s=()=>El("canvas","surf",{width:800,height:608});this.#L=El("div","surf"),this.#D=s(),this.#j=new _C.WL(this.#D,800,608,t),this.#I=El("div","surf"),this.#I.id="GUI",this.#A=s().getContext("2d"),this.#A.imageSmoothingEnabled=!1,this.#A.clr=!1,this.#G=El("div","surf"),css(this.#G,{overflow:"hidden",willChange:"contents"})}#P;#X;#U;#F;#V;#Y;#$;#z;#H;#N;#W;#K;#J;#q;#Z;#Q;#tt;#st;#it;#et;#ht;#rt;#at;#nt;constructor(t,s,i){if(_C.$R.rS=Math.randS(),t.VAR??={},t.ACH??=[],t._i){let s={};t._i.split(",").for(t=>{let[i,e]=t.split(":");s[0|i]=0|e}),t._i=s}this.G=Object.freeze(t),_C.$R.#E(s>1),this.BG=_C.$R.#L,this.gC=_C.$R.#D,this.GUI=_C.$R.#I,this.sfM=_C.$R.#A,this.menu=_C.$R.#G,this.rr=_C.$R.#j,this.#K=s,this.#J=i,this.saveMode=t.S||1,this.#H=t.F||0,Lib.iE(s),this.room=-1,this._r=null,this._co=[],this.sL=[],this.OL=$("ui-ol")}#ot;init(t,s=0){if(s)Res.lM=Infinity,Res.loadNow=0;else{const s=$("screen");s.style.imageRendering=App.gC("run","smooth")?"":"pixelated",s.ap(this.BG,this.gC,this.GUI,this.sfM.canvas,this.menu),$("loading").style.background="",Res.reset(),this.#ot=t}let i=0,e=1;const h=performance.now(),r=Res.dU,a=(s,i)=>{e&&(e=0,Res.dU=r,s&&(console.error(s),t(s)))},n=t=>{a(t)},o={},l=new Set(["jp","st","dth","wj"]),d=new Set,c=new Set,p=new Set,u=[],m=["ftf","fts","ftt","ftc","fst","fkc","fsd","fsc","txt","fta"],f=new Set,y=(t,s)=>{let i,e=t=>{i=t,t._e_=0};const h=(t,e=0,r)=>{if(void 0===t._m_){if(t._m_=0,e)t.jump=[];else for(let s=t.length;s--;)t[s].length&&.03!==t[s][0]||t.splice(s,1);t.for((e,a)=>{if(!e.f)if(e.length&&.03!==e[0]){if(_C.cA[e[0]]?.(e),.04===e[0]){if(!e[2].n){const s=e=>{let h=[1],r=0;for(let t=e.length;t--;)e[t].length&&.03!==e[t][0]||e.splice(t,1);e.for(e=>{e[0]>=8.01&&e[0]<=8.06?(t._m_|=4,$R.cm[e[2]]??=$R.cm.i++,e[2]=$R.cm[e[2]],e[0]<=8.05&&(i._c_??=[],i._c_.add(e[2]))):7.38!==e[0]&&7.39!==e[0]||s(e[2]),e.f=Lib.act[0|e[0]][Math.round(100*e[0]%100-1)]??_C.skip,e[1]?h[++r]=1:h[r]++});let a=h.length-1;0==--h[a]&&a&&h.pop(),e.n=h};let a=e[2];s(a),e[1]&&e[1]<(r||Infinity)&&(a.c=i._e_++),void 0!==a.c&&(e.f=Lib.act[0][2]),h(e[3],0,e[1]),t._m_|=e[3]._m_,e[4]&&(h(e[4],0,e[1]),e[4].length?t._m_|=e[4]._m_:e.splice(4))}}else if(Lib.colAct.includes(e[0])){if(t._m_|=2,2.2===e[0]||2.23===e[0]){"number"==typeof e[1]&&(e[1]=[e[1]]);for(let t=0,s=e[1];t<s.length;t++)$R.cm[s[t]]??=$R.cm.i++,s[t]=$R.cm[s[t]]}else if(1.14===e[0]){let t=f;s&&i&&(i.cspr??=new Set,t=i.cspr),t.add(Lib.cKS(e[1]))}}else if(Lib.movAct.includes(e[0]))t._m_|=1;else if(.02===e[0])0===e[2]?e[2]=Infinity:t.jump.push(a);else if(5.01===e[0])l.add(e[1]);else if(3.16===e[0])l.add(e[2]);else if([3.12,3.13,3.14,5.03].includes(e[0])){let t=f;s&&i&&(i.cspr??=new Set,t=i.cspr),t.add("dm"),e.at(-1).for(s=>{if(6.32===s[0])for(let i=0;i<s[2].length;i++)t.add(s[2][i].split("-")[0])})}else 1.17===e[0]&&e[1].for(t=>{6.09===t[0]&&(d.add(t[1]),c.add(t[1]))});e.f??=Lib.act[0|e[0]][Math.round(100*e[0]%100-1)]}else e.f=_C.skip})}i._m_|=t._m_};if(t.mov&&void 0===t.mov._m_&&(e(t.mov),h(t.mov)),t.tml&&void 0===t.tml._m_&&(e(t.tml),t.tml.for(t=>h(t[1],1))),t.ev&&void 0===t.ev._m_){e(t.ev);for(let s=0;s<t.ev.length;s++)void 0===t.ev[s]._m_&&(t.ev[s]=t.ev[s][1],h(t.ev[s]))}t.trg&&void 0===t.trg._m_&&(e(t.trg),t.trg.for(t=>h(t[1]))),t._m_=t.mov?._m_|t.tml?._m_|t.trg?._m_|t.ev?._m_,t.css&&t.css.for(t=>{6.09===t[0]&&(d.add(t[1]),c.add(t[1]))})},v=(t,s)=>{if(y(t.add,s),t.add.imi&&(t.add.ind=t.add.imi),42===t.ind){let s=t.add,e=s.w+"-"+s.h;m.for(t=>e+=t+"-"+s[t]),o[e]?t.spr=o[e]:(i++,t.spr=this._ST(s,u,e),o[e]=t.spr)}else if(54===t.ind){t.spr=this.shS;let s=t.add.shp[0]??t.add.shp;t.add.ind=s,t.add.lw=t.add.shp.slice?.(1)??[0|(1===s||3===s)]}else if(55===t.ind)t.spr=this.shS,["hcf","hce","hbc"].for(s=>{"string"==typeof t.add[s]&&(t.add[s]=Lib.dec.color(t.add[s]))});else if(64===t.ind){let s=t.add,e="num-";m.slice(0,-4).for(t=>e+=t+"-"+s[t]),o[e]?t.spr=o[e]:(i++,t.spr=this._SN(s,u,e),o[e]=t.spr)}else t.add.til&&(t.add.til>=1e3&&(t.add.til-=1e3),t.add.til>=16&&p.add(t.add.til))},g=$M.cp(Lib.bobj);this.nullSpr=[null],Object.assign(this.nullSpr,{x:0,y:0,w:2,h:2,px:!1,bL:0,bT:0,boxW:2,boxH:2}),this.shS=[-1,-2,-3,-4,-5,-6,-7],Object.assign(this.shS,{x:16,y:16,w:32,h:32,m:0,bL:0,bT:0,boxW:32,boxH:32}),this.sprPly=["_i","_r","_j","_f","_t","_b"],this.resPool=o,this.cm=[0,1],this.cm[-1]=2,this.cm.i=3,[2,3,4,5,6,7,10,19,24,26,27,44,25,56,36,35,38,37,23].for(t=>this.cm[t]=this.cm.i++),s||(this.bgm=new Au.Bgm),this.Sm={},this.G._o.for(t=>{t.def&&(t.add.def=t.def),v(t,1)}),this.G.R.for(s=>{if(s.bg.m>2){if(Res.lB(s.bg,1).catch(a),s.bg.m>=3&&12!==(s.dbg??12))if(3===s.bg.m)s.bg.rgb=Lib.dec.color(s.bg.c);else{let t=s.bg.m+"-"+s.bg.g;if(!o[t]){i++;let e=[];o[t]=e,$M.html2img(`<div style='width:800px;height:608px;background:${s.bg.c}'></div>`,800,608).then(t=>{let s=new OffscreenCanvas(800,608);s.getContext("2d",{willReadFrequently:!0}).drawImage(t,0,0),e.push(s),e.w=800,e.h=608,Res.push("css background")})}s.bg.c=o[t],s.bg.m=1,s.bg.sx=1,s.bg.sy=1}}else{s.bg.id||(s.bg.id=Lib.Db[0]);let t=s.bg.id+(s.bg.g??"");if(o[t])s.bg.c=o[t];else{i++;let e=[];o[t]=e,Res.lB(s.bg,0,1).then(t=>{e[0]=t.c,e.w=t.c.width,e.h=t.c.height,Object.assign(e,{i:-1,n:1,x:0,y:0,tx:0,ty:0,bL:0,bT:0,boxW:e.w,boxH:e.h,ims:0,px:!1,m:0}),t.c=e}).catch(a)}0===s.bg.m?(s.bg.h??=0,s.bg.v??=0):1===s.bg.m&&(s.bg.a??=0),s.bg.m<2&&(s.bg.sx??=1,s.bg.sy??=1)}12===s.dbg&&delete s.dbg;const h=(t,e)=>{if(!s.Spr[t]){if(e??=Lib.gDS(t),!e)return s.Spr[t]=this.nullSpr;let h="";for(let i in s.col)if(s.col[i].split("|").includes(t)){h=i;break}let r=e+h;o[r]?s.Spr[t]=o[r]:(i++,s.Spr[t]=o[r]=[],Res.loadSpr(t,e,h,1,o[r],1,0).catch(a))}return s.Spr[t]},r=t=>["tml","trg","ev"].for(s=>{if(t[s]?.cspr?.size)for(let i of t[s].cspr)h(i)});f.clear(),s.Spr={},s.spr?.for(t=>h(...t.split(":"))),s.type&&(h("ply"),h("blt"),this.#K&&h("sp")),s._i&&s._i.for(t=>{let s=this.G._o[t];[54,55,64].includes(s.ind)||h(s.spr),r(s.add)}),s._o=[],s.grp=[];try{_C.dec.set(s.obj,s.flag,this.G._o),_C.dec.r(t=>s._o[t]=[],({x:t,y:i,prop:e})=>{let a=e.ind;if(0===a)return s.x=t+17,void(s.y=i+23);if(void 0===a)return;const n={ind:a,x:t,y:i,dep:e.add.dep,add:e.add};if(delete e.add.dep,e.def&&(e.add.def=e.def),v(n),s._o[n.dep].push(n),r(n.add),10===a){let t={m:n.add.gpm[0],i:n.add.gid,p:[],o:[]};switch(n.add._gid=s.grp.push(t)-1,t.m){case 0:t.p.x=n.x,t.p.y=n.y;break;case 1:_C.D.circle((s,i)=>t.p.push({x:s,y:i}),n.add.gpm[1],n.add.gpm[2]);break;case 2:_C.D.polygon((s,i)=>t.p.push({x:s,y:i}),n.add.gpm[1],n.add.gpm[3],n.add.gpm[2])}}else 63===a||n.spr||(n.spr=h(e.spr))},!1)}catch(s){return console.error(s),e&&UI.$a(`${i18n(85,0)}`).then(()=>t(s)),i++,a()}if(s._o.for(t=>t.for(t=>{if(t.add.gpi){let i=s.grp.findIndex(s=>t.add.gpi.startsWith(s.i));if(-1===i)delete t.add.gpi;else{let e=s.grp[i];t.add._gi=i,t.add._gn=0|t.add.gpi.slice(e.i.length),0===e.m&&(e.p[t.add._gn]={x:t.x-e.p.x,y:t.y-e.p.y})}}})),Object.freeze(s.grp),s.grp.for(t=>{delete t.p.x,delete t.p.y,t._p=t.p,t.p=[],$M.freeze(t._p)}),Object.freeze(s._o),s.type){let t={};for(let s in g)t[s]={...g[s]};if(s.bobj)for(let i in s.bobj)for(let e in s.bobj[i])null===s.bobj[i][e]?delete t[i][e]:t[i][e]=s.bobj[i][e];for(let s in t)y(t[s],1),r(t[s]);s.bobj=t,["dkc","hcf","hce","hbc","ocf","oce","obc"].for(s=>t.ply[s]=Lib.dec.color(t.ply[s])),t.ply.hct&&Lib.dec.chT(t.ply.hcf,t.ply.hce,t.ply.hct),t.ply.oct&&Lib.dec.chT(t.ply.ocf,t.ply.oce,t.ply.oct),this.G.v<3&&4===s.type&&k_(t.ply,["sJump","sGravDir","sDk"]);let e=t.gov,h="";m.for(t=>h+=t+"1-"+e[t+1]+t+"2-"+e[t+2]),o[h]?s.sprGO=o[h]:(i++,s.sprGO=this._SG(e,m,u,h),o[h]=s.sprGO)}else s.x=s.y=0;if(f.size)for(let t of f)h(t);if(s.bgm.i>=0){let t=this.G._b.find(t=>t.i===s.bgm.i);t?(s.bgm.m=2,s.bgm.i=t.d,s.bgm.a=0!==s.bgm.a,s.bgm.l=0!==s.bgm.l,s.bgm.v=t.v):s.bgm.m=1}else s.bgm.m=-1-s.bgm.i;s.cP??=1,s.cR??=1,s.cI??=1,s.cN??=1,s.ptc??=0}),this.G._b.for(t=>{this.Sm[t.d]||(i++,this.Sm[t.d]=this.loadBgm(t,n,s))}),this.bm=[],this.G._v&&(this.G._v.b?.for(t=>{this.bm[t.i+10]=t,t.cc&&([t.r,t.g,t.b]=Lib.dec.color(t.cc))}),this.G._v.s&&_C.TC.bT(this.G._v.s));for(let t of l)t&&this.G._m[t]&&(s?(i++,Res.getSnd(this.G._m[t],s=>{this.res.snd[this.G._m[t]]=s,Res.push()},a)):Res.snd[t]||(i++,Res.loadSnd(t,this.G._m[t]).catch(a)));if(d.delete(0),i+=d.size,Promise.all(Array.from(d,t=>Res.loadFont(Lib.font[t-1]).catch(t=>a(t)))).then(()=>u.for(t=>t())),!s){this.#et=this.menu.ap(El("div","ab")),this.#et.style.bottom=0,this.#ht=this.menu.ap(El("div","ab a-cen",{id:"pause"}).tx(`- ${i18n(86,0)} -`)._c(El("div","ab"))),this.#ht._h(),this.#ht.i=[["ply",`${i18n(87,0)}`],["timer",`${i18n(88,0)}`],["skull",`${i18n(89,0)}`]].map(([t,s])=>this.#ht.lastChild.ap(El("div",0,{innerHTML:UI.ico(t)+" "+s})).ap(El("span"))),this.#rt=this.GUI.ap(El("div","gui")),this.#at=this.#rt.ch,this.#nt=this.GUI.ap(El("div","ab cen bui")),this.#nt._h(),this.sTime=$("g-time")??{tx(t){this._=t}},this.sDth=$("g-dth")??{tx:this.sTime.tx},this.sTime.val=0,this.sTime.tx("00:00:00"),this.sDth.tx("0");const t=_C.G.prototype;this.G.v<3?t.cOR=_C.skip:t.cOR=t._cR,this.#N=this.main.bind(this),this.draw=this.#lt.bind(this)}Res.lM=i,e&&(Res.dU=()=>setTimeout(()=>{for(let t in this.resPool){let s=this.resPool[t];s.px&&(s.j||s.k?s.getMask=function(t,s,i){return this.mask[0][(i+(this.bT-t*this.k)%this.h+this.h)%this.h*this.w+(s+(this.bL-t*this.j)%this.w+this.w)%this.w]}:s.getMask=function(t,s,i){return this.mask[t][i*this.boxW+s]}),this.rr.addSpr(s),"number"!=typeof s[0]&&(s[0]=s[0]._)}s?(this.res.uv=[],this.res.tex=this.rr.textureMap(this.res.uv,!1),Res.dU=r,r(16)):this.rr.init().then(()=>{Res.dU=r,this.G.R.for(t=>{Object.keys(t.Spr).for(s=>{let i=t.Spr[s];0===i.i&&this.sprPly.for((e,h)=>{let r=h<2?4*h:2*h+4;t.Spr[s+e]=i.slice(r,h<2?r+4:r+2),Object.assign(t.Spr[s+e],{id:e,i:0,ind:h,name:s,x:i.x,y:i.y,tx:0,ty:0,w:32,h:32,px:!1,ims:1===h||4===h?2:5,m:0,bL:i.bL,bT:i.bT,boxW:i.boxW,boxH:i.boxH})})})}),r(Math.max(100-(performance.now()-h),16))}).catch(s=>{Res.dU=r,console.error(s),UI.$a(`${i18n(90,0)}`).then(()=>t(s))})},1))}exit(){this.bgm.destroy();let t=Object.values(this.Sm);setTimeout(()=>t.for(t=>{"0"!==t&&URL.revokeObjectURL(t)}),1e3),Au.clear(),$c("surf",$("screen")).for(t=>t.remove()),[...this.GUI.ch].for(t=>t.remove()),[...this.menu.ch].for(t=>t.remove()),this.rr.free(),this.end(),this.G=null,$R=null}get title(){let t=this.#K?this.G.N+" [Debug Mode]":this.G.N;return this.inGame?`${t} 　 Time: ${this.sTime._}　Death: ${this.sDth._}`:t}#dt(t=!0,s=!0){t&&(this.#Y=null,this.#Z&&(this.#Z=[]),this.#U=0,this.#F=Math.floor(performance.now()),this.#V=0,this.sTime.tx("00:00:00"),this.sDth.tx("0")),s&&(this.VAR={...this.G.VAR},this.ACH=[])}async start(t,s,i,e,h=null,r){Au.enable=!i,this.St=!1,this.end(),this.run=-1,this.#W=Infinity,this.stM=0,this.inGame=!1,this.#z=s,this.#Z=e?[]:null,this.#st=h,this.eC={rand:Math.rand,p:[]},this.L=[];for(let t=0;t<12;t++)this.L[t]=new _C.L(t);if(this.Col={_:new _C.C(this.cm.i),c:[{m:(t,s,i,e,h,r,a)=>{const n=this.$p;return n&&r>n.B[0]&&a>n.B[1]&&e<n.B[2]&&h<n.B[3]&&t._meet(s,i,e,h,r,a,n)?n:null},f(t,s,i,e,h,r,a,n){const o=this.m(t,s,i,e,h,r,a);o&&n.push(o)}},{o:[],m(t,s,i,e,h,r,a){for(let n=0;n<this.o.length;n++){const o=this.o[n];if(!o._des&&r>o.B[0]&&a>o.B[1]&&e<o.B[2]&&h<o.B[3]&&t._meet(s,i,e,h,r,a,o))return o}return null},f(t,s,i,e,h,r,a,n){for(let o=0;o<this.o.length;o++){const l=this.o[o];l._des||r>l.B[0]&&a>l.B[1]&&e<l.B[2]&&h<l.B[3]&&t._meet(s,i,e,h,r,a,l)&&n.push(l)}},iter(t){for(let s=0;s<this.o.length;s++)this.o[s]._des||t(this.o[s])}},{o:[],m(t,s,i,e,h,r,a){for(let n=0;n<this.o.length;n++){const o=this.o[n];if(!o._des&&o.kill&&r>o.B[0]&&a>o.B[1]&&e<o.B[2]&&h<o.B[3]&&t._meet(s,i,e,h,r,a,o))return o}return null},f(t,s,i,e,h,r,a,n){for(let o=0;o<this.o.length;o++){const l=this.o[o];!l._des&&l.kill&&r>l.B[0]&&a>l.B[1]&&e<l.B[2]&&h<l.B[3]&&t._meet(s,i,e,h,r,a,l)&&n.push(l)}return null}}],m(t,s){return s<3?this.c[s].m(t,0,0,t.B[0],t.B[1],t.B[2],t.B[3]):this._.m(t,s)},f(t,s,i){s<3?this.c[s].f(t,0,0,t.B[0],t.B[1],t.B[2],t.B[3],i):this._.f(t,s,i)},mXY(t,s,i,e,h,r,a,n){return s<3?this.c[s].m(t,i,e,h,r,a,n):this._.mXY(t,s,i,e,h,r,a,n)},fXY(t,s,i,e,h,r,a,n,o){s<3?this.c[s].f(t,i,e,h,r,a,n,o):this._.fXY(t,s,i,e,h,r,a,n,o)}},this.colS=[],this.colT=[],$C.kRA(),this.view=new _C.View,this.dvX=this.dvY=this.dvAng=this.dvSc=NaN,this.$p=null,this.#ct=null,this.sfM.clr=!0,this.fls=0,this.flf=0,this.#pt=0,this.#dt(),this.#st)return this.spd=20,void this.rep(r??0);if(this.#z)_S&&this.G.R.some(t=>t.id===_S.r&&0!==t.type&&4!==t.type)&&(this.#Y=$M.cp(_S)),this.#$=null;else{_S=null;try{let t;if(t=(await CIW.query("save","g").eq(this.G.id).get()).filter(t=>t.d),!t.length)throw 0;if(t.sort((t,s)=>(s.p??0)-(t.p??0)),this.#Y=t[0].d,this.#$=t[0].id,!this.G.R.some(t=>t.id===this.#Y.r&&0!==t.type&&4!==t.type))throw 1}catch(t){this.#Y=null,this.#$=null,t&&UI.message(`${i18n(35,0)}`,`${i18n(36,0)}`,3,"#d94")}Ipc.bC.push(()=>this.save(!1))}Au.clear(),this.#ut=!i,-1===t?this.#Y?(this.#ut=!1,this.load()):this.roomTo(0):this.roomTo(t??0,0,0,i),this.#ut=!1,i?(this.#it=!0,this.draw()):(this.main(),this.spd=20)}end(){this.#it=!1,cancelAnimationFrame(this.drawId),clearInterval(this.run),this.drawId=0,this.run=0,this.#ht._h(),this.#nt._h()}#ut=!1;save(t=!0,s,i){if(this._r&&0!==this._r.type&&4!==this._r.type&&(t||this.#Y)){if(t){if(this.#Y={r:this._r.id,x:s??this.plyX,y:i??this.plyY,v:{...this.VAR}},this.#H&&(this.#Y.x=Math.round(this.#Y.x),this.#Y.y=Math.round(this.#Y.y)),this.$p){let t=this._r.bobj.ply,s=this.$p,i=this.#Y;this.G.v>2?(t.sj&&(i.jp=s.jp),t.sg&&(i.gd=s.gd),t.sm&&(i.mh=s.mh),t.sn&&(i.nh=s.nh),t.sd&&(i.dk=s.dk)):(t.sJump&&(i.$j=s.jp),t.sGravDir&&(i.$g=s.gd),t.sDk&&(i.$d=s.dk))}if(this.#Z){if(!this.#ut){const t=this.#Z.at(-1);(this.#Q||t._.length)&&(t.l=this.#tt,t._.push(this.#Q),this.#Q=0,this.#tt=0,this.#Z.push({_:[]}))}this.#Y._r=this.#Z.slice(0,-1)}1===this._r.type&&(this.#Y.c=1)}if(Object.assign(this.#Y,{t:this.#U,d:this.#V,a:[...this.ACH]}),this.#Y.v)for(let t in this.#Y.v)"$"===t[0]&&(this.#Y.v[t]=this.VAR[t]);if(!this.#z){let t=this.#Y;return this.#$?CIW.upd("save",this.#$,s=>{s.updatedAt=new Date,s.d=t}):(this.#$=$M.id(Date.now()),CIW.put("save",{id:this.#$,u:U$.id,g:this.G.id,d:t,p:Date.now(),createdAt:new Date,updatedAt:new Date}))}if(_S=this.#Y,t&&this.CO()){let t=$M.cp(this.#Y);delete t.t,delete t.d,t.u=U$.id,this.OL.RS=t,this.OL.LS=t,this.OL.wR=!1,this.OL.socket.emit("data:save",t)}return!0}}load(){let t=this.#Y;if(!t)return;this.VAR={...this.G.VAR,...t.v},this.#Y.a??=[],this.ACH=[...t.a],this.#U=t.t,this.#V=t.d,this.sDth.tx(this.#V),this.#Z&&(this.#Z=this.#Y._r.slice());let s=this.G.R.findIndex(s=>s.id===t.r);if(this.G.R[s]){let i=this.G.R[s].type;if(0===i||4===i)return;this.$p=null,this.roomTo(s,t.x,t.y),this.inGame=!0}}lR(t){this.OL.wR||t?(this.#Y={...this.OL.RS,t:this.#U,d:this.#V},this.OL.wR=!1,this.OL.sS(this.#Y.u)):this.OL.LS&&(this.#Y={...this.OL.LS,t:this.#U,d:this.#V}),this.load()}CO(){const t=this.OL;return t&&t.on&&"coop"===t.mode}sSD(t){t?this.St&&(this.run=setInterval(this.#N,this.#W),this.#F=Math.floor(performance.now()),this.St=!1):this.run>0&&this.stop()}pause(){if(!this.St&&this._r&&(this._r.cP||this.#st)){if(this.run>0)clearInterval(this.run),this.run=0,$C.LR=[$C.kD[16],$C.kU[16],$C.kO[16]],this.#ht._s(),this.#ht.i[0].tx($("p-top")?.ch[0].ch[0].innerText??U$.getUsername()),this.inGame?(this.#ht.i[1].tx(Date.cT(this.tSec)),this.#ht.i[2].tx(this.#V)):(this.#ht.i[1].tx("00:00:00"),this.#ht.i[2].tx(0)),this.fD=!this.bgm.fD&&1===this.bgm.state,this.fD&&App.gC("run","pause")&&(this.bgm.fO(),Au.clear()),this.sBar&&dac(this.sBar.pN,"");else{if($C.LR){const[t,s,i]=$C.LR;i?t||($C.kD[16]=!1):s||($C.kU[16]=!1),$C.LR=null}this.run=setInterval(this.#N,this.#W),this.#ht._h(),this.#F=Math.floor(performance.now()),this.fD&&this.bgm.fI(),this.sBar&&ac(this.sBar.pN)}this.#st&&this.repB.firstChild.set(this.run>0?1:0);let t=$("g-pause");t&&(this.run>0?t.aC("p"):t.rC("p"))}}stop(){this.run>0&&(clearInterval(this.run),this.run=0),this.St=!0}sRS(t=1){let s={x:this.plyX,y:this.plyY,e:_C.$R.rS,t:this.#U,d:this.#V,v:{...this.VAR}};if(this.#Y&&(s.s={...this.#Y},delete s.s._r,t&&k_(s.s,["r","x","y","v"])),this.G.v>2&&this.$p){let t=this.$p;s.p={jp:t.jp,gd:t.gd,mh:t.mh,nh:t.nh,dk:t.dk}}return s}lRS(t){_C.$R.rS=t.e,this.#U=t.t,this.#V=t.d,this.sTime.tx(Date.cT(this.sTime.val=t.t/1e3<<0)),this.sDth.tx(t.d),this.VAR=$M.cp(t.v??this.G.VAR),this.#Y=t.s,this.$p=null,(t.x||t.y)&&(this.G.v>2&&t.p&&(this.$p=t.p),this.$p=new _C.Y(t.x,t.y))}loadPlayerState(t,s){let i=this._r.bobj.ply,e=this.#Y,{jp:h,gd:r,mh:a,nh:n,og:o,cs:l,ad:d,dk:c}=s??i;s?s.ly&&(i.rj&&(h=i.jp),i.rg&&(r=i.gd),i.rh&&(a=i.mh),i.rn&&(n=i.mh),i.rd&&(c=i.dk)):e&&this._r.type&&4!==this._r.type&&(i.sj&&(h=e.jp??h),i.sg&&(r=e.gd??r),i.sm&&(a=e.mh??a),i.sn&&(n=e.mh??n),i.sd&&(c=e.dk??c)),t.jp=h,t.gd=r,t.mh=a,t.nh=n??a,t.og=i.og,t.cs=i.cs,t.ad=i.ad,t.dk=c}initPly(t){const s=this._r.bobj.ply;this.G.v>2?this.loadPlayerState(t,this.$p):(t.jp=s.sJump?this.#Y?.$j??s.jump:s.jump,t.gd=s.sGravDir?this.#Y?.$g??s.gravDir:s.gravDir,t.cs=s.conShoot,t.ad=s.adMove,t.mh=s.life,t.nh=s.life,t.dk=(s.sDk?this.#Y?.$d??s.dk:s.dk)??0,t.og=250),t.hpt=s.hpt,t.ev=s.ev,["hpw","hph","hal","hcf","hce","hct","hbw","hbc","ogw","ogh","oal","ocf","oce","oct","obw","obc","tml","trg","_m_"].for(i=>t[i]=s[i]),t.fric=s.fr??.5}dec(t,s){if(this.RV={...t.RV},s)this.lRS(s);else if(this.#st&&this.#st[this.#st.id+1]){this.#st.id++;const s=this.#st[this.#st.id];if(s.r!==t.id)UI.err(`${i18n(22,0)}`);else{this.lRS(s),this.run||(this.#ht.i[1].tx(Date.cT(this.tSec)),this.#ht.i[2].tx(this.#V));for(let t in $C.rec){let i=$C.rec[t],e=s.k?.[t];this.#mt[i]=!!(4&e),this.#ft[i]=!!(2&e),this.#yt[i]=!!(1&e)}this.#st.i=0,this.#Q=0,this.repB.$t(s._t),$c("on",this.repB).for(t=>t.style.background=t.i<=this.#st.id?"#5af":"")}}else{if(this.#P||this.#X)this.$p=new _C.Y(this.#P,this.#X);else if(t.x||t.y){let s=t.x,i=t.y;if(this.G.v<3){let e=t.bobj.ply;switch(e.sGravDir?this.#Y?.$g??e.gravDir:e.gravDir){case 90:i-=14;break;case 0:s+=6,i-=8;break;case 180:s-=8,i-=6}}this.$p=new _C.Y(s,i,this.G.v>3)}else this.$p=null;if(this.#ut&&this._r.type&&this.$p&&this.save(),this.#Z){const s=this.#Z.at(-1),i=this.sRS();i.r=t.id,i._=[],s&&void 0===s.l&&(s.l=this.#tt);for(let t in $C.rec){let s=$C.key[$C.rec[t]],e=$C.kO[s]<<2|$C.kU[s]<<1|$C.kD[s];e&&(i.k??={},i.k[t]=e)}this.#Z.push(i),this.#Q=0,this.#tt=0}else this.sBar&&(this.sBar.s=this.sRS(0))}t.grp.for(t=>{t.o.length=0,t.p.length=0,t._p.for((s,i)=>{t.p[i]=s?new _C.GP(s.x,s.y):null})});for(let s=0;s<this.L.length;s++)this.L[s].clear(),t._o[s].for(s=>{let i=new _C.R(s.ind,s.x,s.y,s.dep,s.spr);if(Object.assign(i,s.add),i.gpi&&(i.grp=t.grp[i._gi],i.grp.o.push(i)),10===s.ind){let s=t.grp[i._gid];s.c=i,i._gp=s.p,i.grpO=s.o}i.pI()});2===t.oR&&[[0,-32,t.w/2,16],[-32,-32,16,(t.h+64)/2],[0,t.h,t.w/2,16],[t.w,-32,16,(t.h+64)/2]].for(t=>{let s=new _C.R(3,t[0],t[1],7,this.nullSpr);s.hd=1,s.cm=2,s.scx=t[2],s.scy=t[3],s.pI()}),this.view.init();let i=this.L.map(t=>t.o.length);for(let t=0;t<this.L.length;t++){const s=this.L[t].o;for(let e=0;e<i[t];e++)s[e].init()}this.view.update(!0),this.activate(!0),this.$p?.init()}roomTo(t,s=0,i=0,e,h=1,r){let a=this.G.R[t];if(a){if(0===a.type&&this.#dt(!1),a.bgm.m&&!a.bgm.a&&this.bgm.stop(),this.room!==t){if(a.bgm.m>1&&!e)if("0"===this.Sm[a.bgm.i])this.bgm.stop();else{const t=()=>{h||this.run?this.bgm.vol=a.bgm.v??100:(this.bgm._vol=(a.bgm.v??100)/100,this.run||this.bgm.pause())};this._r&&this._r.bgm.i===a.bgm.i?this._r.bgm.l!==a.bgm.l&&(this.bgm.loop=a.bgm.l,a.bgm.a&&a.bgm.l&&0===this.bgm.state&&this.bgm.play().then(t)):(this.bgm.url=this.Sm[a.bgm.i],this.bgm.loop=a.bgm.l,a.bgm.a&&this.bgm.play().then(t))}a.bg.m>2?this.BG.style.background=a.dbg<12?"#000":a.bg.c:(this.BG.style.background="#000",this._r&&this._r.bg.id===a.bg.id&&this._r.bg.m===a.bg.m||(this.bgX=0,this.bgY=0,this.bgA=0)),this.room=t,this._r=a,this.#nt.upd=!0,this.#vt()}(h||this.run)&&this.bgm.fI();for(let t of this.#at)t.o=null,t._h();this.#nt._h(),this.plyX=0,this.plyY=0,this.flA=0,this.flD=0,this.#gt=-1,this.#bt=0,this.Col.c[1].o.length=0,this.Col.c[2].o.length=0,this.Col._.init(a.w,a.h,32),this.ev=[],this.trg=[],this.counter=[],this._co.length=0,this.#P=s,this.#X=i,void 0!==r&&(this.#ct=null,this.sfM.clr=!0,this.fls=0,this.flf=0),this.dec(a,r),this.Tm=this.bgm.time,this.sRoom&&(this.sRoom.innerText=this._r.name,this.sBar.t=-1),0===a.type?this.inGame=!1:1!==a.type&&2!==a.type||(this.inGame=!0),this.sTime._&&this.sTime.tx(this.sTime._)}}#xt=[0,"#000"];#ct=null;#gt=-1;#wt=25;#Rt;#Mt;#Bt;#_t;#Ct;warp(t,s,i=0,e=0,h=0){if(this.#gt>=0)return;let r=1===t?this.room+1:0===t?this.room:this.G.R.findIndex(s=>s.id===t);switch(this.$p&&(this.$p.fz=!0),s?.length||(s=this.#xt),this.#Rt=r,this.#Mt=s,this.#Bt=i,this.#_t=e,this.#Ct=h,s[0]){case 1:this.#gt=0;break;case 2:this.#ct={sc:0,ang:0,col:s[1],asp:s[2]*Math.DR,move(){this.sc=1.1*this.sc+1,this.ang-=this.asp},draw(){const t=$R.sfM;t.save(),t.translate(400,304),t.rotate(this.ang),t.fillStyle=this.col,t.globalAlpha=1,t.fillRect(-4*this.sc,-3*this.sc,8*this.sc,6*this.sc),t.restore(),t.clr=!0}},this.#gt=35;break;case 3:if(this.#ct={sc:512,col:s[1],stage:0,move(){this.stage?(this.sc+=10+this.sc/32,this.sc>=800&&($R.sfM.clr=!0,$R.#ct=null)):this.sc&&(this.sc-=10+this.sc/32,this.sc<0&&(this.sc=0))},draw(){const t=$R.sfM;if(t.save(),t.fillStyle=this.col,t.globalAlpha=1,t.fillRect(0,0,800,608),this.sc){t.globalCompositeOperation="destination-out";let s=400,i=304,e=this.sc;if(void 0!==this.x){const h=$R.view;s=this.x-h.cameraX,i=this.y-h.cameraY,e*=h.s,t.translate(400,304),t.scale(1/h.s,1/h.s),t.rotate(h.a*Math.DR)}t.beginPath(),t.arc(s,i,e,0,Math.PI2),t.fill()}t.restore()}},this.$p){this.#ct.x=this.$p.x,this.#ct.y=this.$p.y;const t=(this.$p.x-this.view.cameraX)/this.view.s,s=(this.$p.y-this.view.cameraY)/this.view.s;this.#ct.sc=1.42*Math.max(400+t,400+s,400-t,400-s)<<0}let t=this.#ct.sc,i=0;for(;t>0;)t-=10+t/32,i++;this.#gt=i+8;break;case 4:this.#ct={sc:0,col:s[1],move(){1===this.stage?this.sc>0?this.sc-=1.5:($R.sfM.clr=!0,$R.#ct=null):this.sc<53&&(this.sc+=1.5)},draw(){const t=$R.sfM;t.save(),t.fillStyle=this.col,t.globalAlpha=1;for(let s=0;s<25;s++){let i=32*s+16;for(let e=0;e<19;e++){let h=32*e+16,r=Math.mM(this.stage?this.sc+Math.abs(s-12)+Math.abs(e-9)-21:this.sc-Math.abs(s-12)-Math.abs(e-9),0,32);r&&t.fillRect(i-r/2,h-r/2,r,r)}}t.restore(),t.clr=!0}},this.#gt=40;break;case 5:this.#gt=s[1]||25;break;default:this.#gt=(s[2]??25)+5,s[3]&&(this.#wt=s[3]),this.flash(s[1],0,1,this.#gt-5)}this.#gt&&this.#kt(this.G.R[r])}flash(t,s,i,e){this.sfM.fillStyle=t,this.flf=s,this.flt=i,this.fls=(i-s)/e}#bt;#kt(t){let s=t.bgm;(s.m&&!s.a||s.m>1&&this._r.bgm.i!==s.i)&&(this.#bt=this.#gt)}#vt(){let t=this._r?.bgm;this.bgm.au.playbackRate=Infinity!==this.#W&&t?.m>1&&t?.s?20/this.#W:1}guP(){for(let t of this.#at)if(!t.o)return t;return this.#rt.ap(El("div")._c(El("pre")))}showBoard(t){_C.ST(this.#nt,this._r.bobj.bui.css),this.#nt.tx(t)._s(),this.#nt.on?clearTimeout(this.#nt.on):this.#nt.style.opacity=0,this.#nt.on=setTimeout(()=>{this.#nt.on=0,this.#nt.style.opacity=1},20)}closeBoard(){this.#nt.on&&clearTimeout(this.#nt.on),this.#nt.style.opacity="",this.#nt.on=setTimeout(()=>{this.#nt.on=0,this.#nt._h()},400)}activate(t=!1){const s=this.view,i=s.AL,e=s.AT,h=s.AR,r=s.AB;if(t){for(let t=0;t<this.L.length;t++)this.L[t].init();for(let t=0;t<this.L.length;t++){const s=this.L[t].o;for(let t=0;t<s.length;t++)s[t]._des||s[t].activate(i,e,h,r)}}else{for(let t=0;t<11;t++)this.L[t].a.length=0;for(let t=0;t<11;t++){const s=this.L[t].o;for(let t=0;t<s.length;t++)s[t]._des||(s[t].cB(),s[t].activate(i,e,h,r))}}this.upd=!0}get notReplay(){return!this.#st}get time(){return this.#U}get dth(){return this.#V}addDth(){this.sDth.tx(++this.#V)}get svS(){return this.#Y?1+(0|this.#Y.c):0}get svI(){return this.#$}get tSec(){return this.#U/1e3<<0}get spd(){return this.#W}set spd(t){this.#K||this.#st||(t=20),this.#W!==t&&(this.#W=t,this.run&&(this.run>0&&clearInterval(this.run),this.run=setInterval(this.#N,t)),this.#vt())}get god(){return this.#q}gVR(t){return this.VAR["$"+t]??this.VAR[t]}sVR(t,s){void 0!==this.VAR["$"+t]?this.VAR["$"+t]=s:void 0!==this.VAR[t]&&(this.VAR[t]=s)}gRV(t){return this.RV[t]}sRV(t,s){void 0!==this.RV[t]&&(this.RV[t]=s)}gAc(t,s){if(!this.#st&&!this.ACH.includes(t)){let i=this.G.ACH.find(s=>s.id===t);if(i){this.ACH.push(t);let e=this.#et.ap(El("div","ach rl")._c(El("div","a-cen ab n-w").tx(i.c),El("h6","n-w").tx(i.n),El("p","n-w dots cm").tx(i.d)));e.animate([{marginBottom:"-64px",easing:"ease-out"},{marginBottom:"8px",offset:.1},{opacity:1,easing:"ease-out",offset:.8},{opacity:0}],{duration:4e3,fill:"forwards"}),setTimeout(()=>e.remove,4e3),s&&Au.play(s)}}}#pt;newGame(t){const s=()=>{this.warp(1,t,0,0,1),this.stM=1,this.#Y=null,this.#z||this.#$&&(CIW.del("save",this.#$),this.#$=null)};if(this.G.R[this.room+1])if(this.$p&&(this.$p.fz=!0),this.#Y){if(this.#pt)return;this.#pt=1,(new UI.M).t(`${i18n(91,0)}`).b(`${i18n(92,0)}`,`${i18n(93,0)}`,`${i18n(1,0)}`).then(t=>{this.#pt=0,2===t.i?this.$p&&(this.$p.fz=!1):(0===t.i&&(this.#$=null),s())})}else s()}loadGame(t){if(!this.#Y)return;let s=this.G.R.findIndex(t=>t.id===this.#Y.r);if(this.G.R[s]){let i=this.G.R[s].type;if(0===i||4===i)return;this.warp(this.#Y.r,t),this.stM=2}}#St(){4===this._r.type?(this.#Z&&this.#Z.splice(-1),this.$p=null,this.roomTo(this.room)):(this.save(!1),this.CO()?this.lR():this.load())}#yt=[];#ft=[];#mt=[];C(t){return this.#st?this.#mt[t]||this.#yt[t]:$C.C(t)}P(t){return this.#st?this.#yt[t]:$C.P(t)}R(t){return this.#st?this.#ft[t]:$C.R(t)}rep(t){const s=this.#st[t];s&&void 0!==s.r&&(Au.clear(),this.repB??=$("ui-rp"),this.#st.id=t-1,this.roomTo(this.G.R.findIndex(t=>t.id===s.r),0,0,0,0,0),this.run<=0&&(Au.enable=!1,this.main(),Au.enable=!0))}tE(t,s){throw this.end(),UI.$a(s).then(()=>this.#ot()),t}mE(t,s,i,e){this.end();let h=`${i18n(94,0)}`;throw h+=0===s?`${i18n(95,0)}(${t.xs},${t.ys}) > ${i18n(96,0)}${i} > ${i18n(97,0)}${e}`:1===s?`${i18n(95,0)}(${t.xs},${t.ys}) > ${i18n(98,0)}${i}`:`${i18n(99,0)}(${t.xs},${t.ys})`,(new UI.M).t(`${i18n(100,0)}`+(this.#K?`${i18n(117,0)}`:"")).t(h).b(`${i18n(0,0)}`).then(()=>this.#ot()),"max loop exceeded"}eEE(t,s){throw this.end(),(new UI.M).t("表达式执行错误："+t).t(`${i18n(94,0)}${i18n(95,0)}(${s.xs},${s.ys})`).b(`${i18n(0,0)}`).then(()=>this.#ot()),"expression execution error"}main(){if((this.#gt>0||UI.bg.n||UI.menu.on)&&$C.kPA(),-1===this.#gt)this.#ct||($C.kO[17]&&$R.P("r")&&this.CO()?this.OL.RS&&this.lR(!0):this._r.type&&($R.P("f2")?(this.$p&&(this.$p.fz=!0),this.flash("#000",0,1,40),this.#gt=50,this.#Rt=0,this.#Bt=this.#_t=0,this.#Mt=this.#xt,this.stM=3,this.#kt(this.G.R[0])):$R.P("r")&&this._r.cR&&this.#St()));else if(0===this.#gt){switch(this.stM){case 3:this.#J?this.#dt():this.save(!1),this.$p=null,Au.clear();case 0:3===this.stM&&(this.stM=0,this.#J&&(this.#ut=!0)),this.roomTo(this.#Rt,this.#Bt,this.#_t),this.#ut=!1;break;case 2:this.stM=0,this.load();break;case 1:this.stM=0,this.inGame=!0,this.#dt(!0,!1),this.roomTo(this.room+1);break;case 4:this.#St()}switch(this.$p&&this.save(this.#Ct),this.#Ct=!1,this.#Mt[0]){case 1:case 5:break;case 3:const t=this.#ct;this.$p&&(t.x=this.$p.x,t.y=this.$p.y),t.stage=1;break;case 4:this.#ct.stage=1;break;default:this.#ct=null,this.flash(this.#Mt[1],1,0,this.#wt),this.#wt=25}}else this.#gt--,this.#bt&&(this.bgm.vol=this.#gt/this.#bt*(this._r.bgm.v??100));if(this.#st){const t=this.#st[this.#st.id]?._;if(t){const s=t[this.#st.i];if(s?.split){const i=s.match(/\d+/),e=s.slice(i.length);if(this.#Q===Number(i)){for(;"0"===t[this.#st.i+1]?.[0];)this.#st.i++;const[s,i=""]=e.split("-");for(let t=0;t<s.length;t++){const i=$C.rec[s[t]];this.#yt[i]=!0,this.#mt[i]=!0}for(let t=0;t<i.length;t++){const s=$C.rec[i[t]];this.#ft[s]=!0,"/"===i[t+1]?(this.#mt[s]=!0,t++):this.#mt[s]=!1}this.#st.i++,this.#Q=0}}}}else if(this.#Z){let t="",s="";for(let i in $C.rec){let e=$C.key[$C.rec[i]];$C.kD[e]&&(t+=i),$C.kU[e]&&(s+=i,$C.kO[e]&&(s+="/"))}s?(this.#Z.at(-1)._.push(this.#Q+t+"-"+s),this.#Q=0):t&&(this.#Z.at(-1)._.push(this.#Q+t),this.#Q=0)}this.sL.length&&(this.sL.length=0);let t=this.Col.c[1];this.L.for(t=>t.iter(t=>t.step0())),this.$p&&this.$p.step0(),t.iter(t=>t.step0()),this.L.for(t=>t.iter(t=>t.timer())),this.$p&&this.$p.timer(),t.iter(t=>t.timer()),this.$p&&this.$p.step(),this.L.for(t=>t.iter(t=>t.step1())),this.$p&&this.$p.step1(),t.iter(t=>t.step1());for(let t=this._co.length;t--;)this._co[t].move()&&this._co.splice(t,1);this.L.for(t=>t.iter(t=>t.move())),this._r.grp.for(t=>{t.c._des||t.c.gpi||t.c.updGrp()}),this.L.for(t=>t.iter(t=>t.colli()));let s=0,i=[];for(;this.colS.length&&s++<256;){for(;this.colS.length;){let t=this.colS.shift();t.h_+=t.outH,t.v_+=t.outV,t.outH=0,t.outV=0,(t.outX||t.outY)&&(t.Bm(t.outX,t.outY),t.outX=0,t.outY=0,$R.Col._.upd(t)),t.outIn=!0,t.outF&&(i.push(t),t.outF=!1)}for(let t=0;t<this.colT.length;t++)this.colT[t]._colli()}i.for(t=>{Math.round(t.x)===Math.round(t.xp)&&(t.$x=t.xp),Math.round(t.y)===Math.round(t.yp)&&(t.$y=t.yp);let s=t.h_;t.h_++,t.$hvspd(s,t.v_),t.outF=!0,t.m_&&t.uCB()}),this.colT.length=0,this.colS.length=0;let e=this.Col.c[2].o;if(e.length){this.L[7].upd=!0;let t=0,s=0;for(let i=0;i<e.length;i++)e[i].move(),e[i]._des?(t=i,s++):s&&(e.splice(t-s+1,s),i-=s,s=0);s&&e.splice(t-s+1,s)}this.$p&&this.$p.move(),t.iter(t=>t.move()),this.L.for(t=>t.iter(t=>t.step2())),this.$p&&this.$p.step2(),t.iter(t=>t.step2());for(let t=this.ev.length;t--;)this.ev[t]=0;this.$p&&this.$p.colli();for(let s=t.o.length;s--;)t.o[s].colli(),t.o[s]._des&&t.o.splice(s,1);let h=this.view.update();this.sL.for(t=>{t._des||(t.yO&&(void 0!==t.syncX&&(t.$x=t.yO.x*t.syncXS+t.syncX),void 0!==t.syncY&&(t.$y=t.yO.y*t.syncYS+t.syncY),t.m_&&t.uCB()),64===t.obj&&t.updNum())}),this.L.for(t=>t.gc()),h&&this.activate();const r=this.trg;for(let t=r.length;t--;)1===r[t]?r[t]=2:3===r[t]&&(r[t]=0);if(0===this._r.bg.m?this._r.bg.h||this._r.bg.v?(this.bgX+=this._r.bg.h,this.bgY+=this._r.bg.v,this.L[this._r.dbg??11].upd=!0):(this.view.L<this.dBgL||this.view.T<this.dBgT||this.view.R>this.dBgR||this.view.B>this.dBgB)&&(this.L[this._r.dbg??11].upd=!0):1===this._r.bg.m&&this._r.bg.a&&(this.bgA+=this._r.bg.a,this.L[this._r.dbg??11].upd=!0),this.flD&&(Math.abs(this.flT-this.flA)>Math.abs(this.flD)?this.flA+=this.flD:(this.flA=this.flT,this.flD=0),this.L[11].upd=!0),this.fls&&(Math.abs(this.flt-this.flf)>Math.abs(this.fls)?this.flf+=this.fls:(this.flf=this.flt,this.fls=0)),this.#ct&&this.#ct.move(),this._r.bgm.m>1&&this._r.bgm.s&&1===this.bgm.state?(Math.abs(this.Tm-this.bgm.time)>.1&&(this.bgm.time=this.Tm),this.Tm+=.02,this.Tm>this.bgm.len&&this.bgm.loop&&(this.Tm-=this.bgm.len)):this.Tm&&0===this.bgm.state&&(this.Tm=0),this.#st){for(let t in $C.rec){let s=$C.rec[t];this.#yt[s]=!1,this.#ft[s]=!1}const t=this.#st[this.#st.id]?._;if(t){const s=t[this.#st.i];if(this.#Q===s){const t=this.#st[this.#st.id+1],s=t?.r;if(void 0!==s)this.#Rt=this.G.R.findIndex(t=>t.id===s),this.#Mt=[1],this.#Bt=0,this.#_t=0,this.#gt=0;else if(this.#st.id++,this.#st.i=0,this.#Q=0,!t)for(let t in $C.rec){let s=$C.rec[t];this.#mt[s]=!1,this.#ft[s]=!1,this.#yt[s]=!1}}this.#Q++}}else this.#Z&&(this.#Q++,this.#tt++),$C.kCA();let a=performance.now(),n=Date.now(),o=Math.floor(a),l=o-this.#F;2===this._r.type&&(this.#U+=this.#st?20:l);let d=this.tSec;d!==this.sTime.val&&(this.sTime.val=d,this.sTime.tx(Date.cT(d))),this.#st&&this.repB.$t(this.repB._t+20,!1),this.#F=o;const c=this.OL;if(c?.on&&c.playerNum>1){c.frame++;const t=c.ps;for(const s in t)if(s===U$.id){if(c.frame%c.spd==0)if(this.$p){let i=t[s],e=this.$p.dk<<6|(270-this.$p.gd)/90<<4|(this.$p.scx<0)<<3|this.$p.spr.ind,h=!1;this.$p.x!==i.x&&(i.x=this.$p.x,h=!0),this.$p.y!==i.y&&(i.y=this.$p.y,h=!0),e!==i.s&&(i.s=e,h=!0),this._r.id!==i.r&&(i.r=this._r.id,h=!0),h&&c.socket.volatile.emit("data:pos",{x:i.x,y:i.y,s:i.s,r:i.r})}else t[s].r>=0&&(t[s].r=-this._r.id,c.socket.volatile.emit("data:pos",{r:-this._r.id}))}else t[s].r===this._r.id&&c.frame%5==0&&(this.L[7].upd=!0);n-c.ping>3e4&&(c.ping=n,c.socket.emit("ping",()=>{c.status.update(Date.now()-n)}))}this.#it=!0,this.drawId||this.draw()}#lt(){if(this.drawId=0,this.#it){if(this.sfM.clr&&(this.sfM.clearRect(0,0,800,608),this.sfM.clr=!1),this.#ct?.draw?.(),this.flf>0&&(this.sfM.globalAlpha=this.flf,this.sfM.fillRect(0,0,800,608),this.sfM.clr=!0,this.flf>=1))return void(this.run&&(this.drawId=requestAnimationFrame(this.draw)));let t=this.view,s=t.cameraX,i=t.cameraY,e=t.a,h=t.s,r=s!==this.dvX||i!==this.dvY,a=e!==this.dvAng||h!==this.dvSc,n=this.upd||this.L.some(t=>t.upd);r&&this.rr.vC(s,i),a&&this.rr.vT(1/h,1/h,-e),this.upd=!1,this.dvX=s,this.dvY=i,this.dvAng=e,this.dvSc=h,n&&(this.rr.updO(),this.L.for(t=>t.draw())),(n||r||a)&&(this.rr.render(),this.rps++),this.#it=!1}this.run&&(this.drawId=requestAnimationFrame(this.draw))}},Object.assign(_C.$R.prototype,{_ST(){let t=[];return Res.initSpr(t,$R.G._s["txt"+Res.svg++]),setTimeout(()=>Res.push(),10+10*Math.random()),t},_SN(){return this._ST()},_SG(){return this._ST()},loadBgm(t,s){let i=s=>{this.Sm[t.d]=URL.createObjectURL(s),Res.push()};return CIW.get("bgm",t.d).then(t=>i(t.b),e=>{$M.xhr("GET",CDN+"music/"+t.d,"blob",null,300).then(s=>{CIW.put("bgm",{id:t.d,b:s.response}),Res.lT(0,1),i(s.response)},t=>s(t.err)),Res.lT(0,0)}),"0"}}),_C.C=class{constructor(t,s=32){this.cls=t,this.size=s,this.grid=[]}init(t,s,i=32){for(let t=0;t<this.cls;t++)this.grid[t]=[];this.outL=Math.floor(-i/this.size),this.outT=Math.floor(-i/this.size),this.outR=Math.ceil((t+i)/this.size),this.outB=Math.ceil((s+i)/this.size),this.Cn=0}add(t){if(t._des)return;const s=Math.floor(t.B[0]/this.size),i=Math.floor(t.B[1]/this.size),e=Math.ceil(t.B[2]/this.size),h=Math.ceil(t.B[3]/this.size);if(t.Bc[0]=s,t.Bc[1]=i,t.Bc[2]=e,t.Bc[3]=h,!(this.outR<=s||this.outB<=i||this.outL>=e||this.outT>=h)||t.gpi||t.or)for(let r=0;r<t.cmL.length;r++){const a=t.cmL[r];void 0===t.cmI[a]&&(t.cmI[a]=[]);const n=t.cmI[a],o=this.grid[a];let l=0;for(let r=s;r<e;r++){void 0===o[r]&&(o[r]=[]);for(let s=i;s<h;s++)void 0===o[r][s]&&(o[r][s]=[]),n[l++]=o[r][s].push(t)-1}}else t.outRoom()}rm(t){if(!t.cmI.length)return;const s=t.Bc[0],i=t.Bc[1],e=t.Bc[2],h=t.Bc[3];for(let r=0;r<t.cmL.length;r++){const a=t.cmL[r],n=t.cmI[a],o=this.grid[a];let l=0;for(let t=s;t<e;t++)for(let s=i;s<h;s++){const i=n[l++],e=o[t][s].length-1;if(i<e){const h=o[t][s][e],r=h.Bc[0],n=h.Bc[1],l=h.Bc[3]-n;o[t][s][i]=h,h.cmI[a][(t-r)*l+s-n]=i}o[t][s].pop()}}}upd(t){if(t._des)return;t.cB();const s=Math.floor(t.B[0]/this.size),i=Math.floor(t.B[1]/this.size),e=Math.ceil(t.B[2]/this.size),h=Math.ceil(t.B[3]/this.size);if(!(this.outR<=s||this.outB<=i||this.outL>=e||this.outT>=h)||t.gpi||t.or){const r=t.Bc[0],a=t.Bc[1],n=t.Bc[2],o=t.Bc[3];if(s!==r||i!==a||e!==n||h!==o){t.Bc[0]=s,t.Bc[1]=i,t.Bc[2]=e,t.Bc[3]=h;for(let l=0;l<t.cmL.length;l++){const d=t.cmL[l],c=t.cmI[d],p=this.grid[d];let u=0;for(let t=r;t<n;t++)for(let s=a;s<o;s++){const i=c[u++],e=p[t][s].length-1;if(i<e){const h=p[t][s][e],r=h.Bc[0],a=h.Bc[1],n=h.Bc[3]-a;p[t][s][i]=h,h.cmI[d][(t-r)*n+s-a]=i}p[t][s].pop()}u=0;for(let r=s;r<e;r++){void 0===p[r]&&(p[r]=[]);for(let s=i;s<h;s++)void 0===p[r][s]&&(p[r][s]=[]),c[u++]=p[r][s].push(t)-1}}}}else t.outRoom();t.m_=!1}swap(t,s){if(t._des)return;t.cmL.length||t.cB();const i=Math.floor(t.B[0]/this.size),e=Math.floor(t.B[1]/this.size),h=Math.ceil(t.B[2]/this.size),r=Math.ceil(t.B[3]/this.size);t.Bc[0]=i,t.Bc[1]=e,t.Bc[2]=h,t.Bc[3]=r,t.cmL.for(a=>{if(!s.includes(a)){const s=t.cmI[a],n=this.grid[a];let o=0;for(let t=i;t<h;t++)for(let i=e;i<r;i++){const e=s[o++],h=n[t][i].length-1;if(e<h){const s=n[t][i][h],r=s.Bc[0],o=s.Bc[1],l=s.Bc[3]-o;n[t][i][e]=s,s.cmI[a][(t-r)*l+i-o]=e}n[t][i].pop()}}}),s.for(s=>{if(!t.cmL.includes(s)){t.cmI[s]??=[];const a=t.cmI[s],n=this.grid[s];let o=0;for(let s=i;s<h;s++){void 0===n[s]&&(n[s]=[]);for(let i=e;i<r;i++)void 0===n[s][i]&&(n[s][i]=[]),a[o++]=n[s][i].push(t)-1}}}),t.cmL=s}m(t,s){const i=t.B[0],e=t.B[1],h=t.B[2],r=t.B[3],a=Math.floor(i/this.size),n=Math.floor(e/this.size),o=Math.ceil(h/this.size),l=Math.ceil(r/this.size);this.Cn++;for(let d=a;d<o;d++)if(this.grid[s][d])for(let a=n;a<l;a++){const n=this.grid[s][d][a];if(n)for(let s=0;s<n.length;s++){const a=n[s];if(a!==t&&a.Cn!==this.Cn&&(a.Cn=this.Cn,h>a.B[0]&&r>a.B[1]&&i<a.B[2]&&e<a.B[3]&&t._meet(0,0,i,e,h,r,a)))return a}}return null}mXY(t,s,i,e,h,r,a,n){const o=Math.floor(h/this.size),l=Math.floor(r/this.size),d=Math.ceil(a/this.size),c=Math.ceil(n/this.size);this.Cn++;for(let p=o;p<d;p++)if(this.grid[s][p])for(let o=l;o<c;o++){const l=this.grid[s][p][o];if(l)for(let s=0;s<l.length;s++){const o=l[s];if(o!==t&&o.Cn!==this.Cn&&(o.Cn=this.Cn,a>o.B[0]&&n>o.B[1]&&h<o.B[2]&&r<o.B[3]&&t._meet(i,e,h,r,a,n,o)))return o}}return null}mP(t,s,i){const e=Math.floor(t/this.size);if(this.grid[i][e]){const h=this.grid[i][e][Math.floor(s/this.size)];if(h)for(let i=0;i<h.length;i++){const e=h[i];if(t>=e.B[0]&&s>=e.B[1]&&t<=e.B[2]&&s<=e.B[3])return e}}return null}f(t,s,i){const e=t.B[0],h=t.B[1],r=t.B[2],a=t.B[3],n=Math.floor(e/this.size),o=Math.floor(h/this.size),l=Math.ceil(r/this.size),d=Math.ceil(a/this.size),c=[];for(let i=n;i<l;i++)if(this.grid[s][i])for(let n=o;n<d;n++){const o=this.grid[s][i][n];if(o)for(let s=0;s<o.length;s++){const i=o[s];i===t||i._inCol||r>i.B[0]&&a>i.B[1]&&e<i.B[2]&&h<i.B[3]&&(i._inCol=!0,c.push(i))}}for(let s=0;s<c.length;s++){const n=c[s];n._inCol=!1,t._meet(0,0,e,h,r,a,n)&&i.push(n)}}fXY(t,s,i,e,h,r,a,n,o){const l=Math.floor(h/this.size),d=Math.floor(r/this.size),c=Math.ceil(a/this.size),p=Math.ceil(n/this.size),u=[];for(let i=l;i<c;i++)if(this.grid[s][i])for(let e=d;e<p;e++){const o=this.grid[s][i][e];if(o)for(let s=0;s<o.length;s++){const i=o[s];i===t||i._inCol||a>i.B[0]&&n>i.B[1]&&h<i.B[2]&&r<i.B[3]&&(i._inCol=!0,u.push(i))}}for(let s=0;s<u.length;s++){const l=u[s];l._inCol=!1,t._meet(i,e,h,r,a,n,l)&&o.push(l)}}fL(t,s,i,e,h,r){let a=r*Math.DR,n=Math.sin(a),o=Math.cos(a),l=h*o,d=h*-n,c=(l*e-d*i)/this.size,p=Math.SQRT1_2*h,u=1,m=null,f=Math.floor(i/this.size),y=Math.floor(e/this.size),v=Math.floor((i+l)/this.size),g=Math.floor((e+d)/this.size),b=f>v?-1:1,x=y>g?-1:1;v+=b,g+=x;for(let r=f;r!==v;r+=b)if(this.grid[s][r])for(let a=y;a!==g;a+=x){const f=this.grid[s][r][a];if(f&&Math.abs(d*(r+.5)-l*(a+.5)+c)<=p)for(let s=0;s<f.length;s++){const c=f[s];if(c===t)continue;let p=c.V,y=1,w=0,R=0;for(let t=0;t<8;t+=6)for(let s=2;s<6;s+=2){let f=p[s]-p[t],M=p[s+1]-p[t+1],B=l*M-d*f,_=p[t]-i,C=p[t+1]-e;if(B){if(R)continue;let t=(_*M-C*f)/B,s=(_*d-C*l)/B;t>=0&&s>=0&&s<=1&&(w++,t<y&&(y=t))}else{if(_*d-C*l!=0)continue;let t=n*_+o*C,f=n*(p[s]-i)+o*(p[s+1]-e);if(t<=0&&f<=0)continue;let y=(t<f?t:f)/h;y<u&&(u=y>0?y:0,m=c,v=r+b,g=a+x,R=1)}}if(R||(1===w?y>0&&(u=0,m=c):y<u&&(u=y,m=c,v=r+b,g=a+x)),0===u)return{h:0,o:m}}}return{h:u*h,o:m}}},_C.M=class{constructor(t,s){this.x=t,this.y=s,this.h_=0,this.v_=0,this.spd=0,this.dir=0,this.hacc=0,this.vacc=0,this.acc=0}set $h_(t){if(t!==this.h_)if(this.h_=t,this.v_){this.spd=(t*t+this.v_*this.v_)**.5;let s=-Math.atan(this.v_/t)/Math.DR;this.dir=(t<0?s+180:s+360)%360}else this.spd=Math.abs(t),t&&(this.dir=t<0?180:0)}set $v_(t){if(t!==this.v_)if(this.v_=t,this.h_){this.spd=(this.h_*this.h_+t*t)**.5;let s=-Math.atan(t/this.h_)/Math.DR;this.dir=(this.h_<0?s+180:s+360)%360}else this.spd=Math.abs(t),t&&(this.dir=t<0?90:270)}$hvspd(t,s){if((t!==this.h_||s!==this.v_)&&(this.h_=t,this.v_=s,this.spd=(t*t+s*s)**.5,this.spd)){let i=-Math.atan(s/t)/Math.DR;this.dir=(t<0?i+180:i+360)%360}}set $spd(t){if(t!==this.spd){this.spd=t;let s=this.dir*Math.DR;this.h_=Math.cos(s)*t,this.v_=-Math.sin(s)*t}}set $dir(t){if(t!==this.dir&&(this.dir=(t%360+360)%360,this.spd)){let s=t*Math.DR;this.h_=Math.cos(s)*this.spd,this.v_=-Math.sin(s)*this.spd}}$Sd(t,s){if(t!==this.spd||s!==this.dir){this.spd=t,this.dir=(s%360+360)%360;let i=s*Math.DR;this.h_=Math.cos(i)*t,this.v_=-Math.sin(i)*t}}$dspd(t,s,i){if(t||s){let e=(t*t+s*s)**.5,h=-Math.atan(s/t)/Math.DR;this.dir=i<0?(t<0?h+360:h+180)%360:(t<0?h+180:h+360)%360,t=i*t/e,s=i*s/e,this.spd=Math.abs(i),this.h_=t,this.v_=s}else this.spd=0,this.h_=0,this.v_=0}$aA(){if(this.acc<0&&this.spd){let t=(this.spd+this.acc*Math.sign(this.spd))/this.spd;t<=0?(this.spd=0,this.h_=0,this.v_=0):(this.spd*=t,this.h_*=t,this.v_*=t)}else this.acc>0&&(this.$spd=this.spd+this.acc*(this.spd<0?-1:1));(this.hacc||this.vacc)&&this.$hvspd(this.h_+this.hacc,this.v_+this.vacc)}},_C.O=class extends _C.M{constructor(t,s){super(t,s),this.scx=1,this.scy=1,this.ang=0,this.ind=0,this.al=1,this.rgb=[1,1,1],this.cbm=0,this._des=!1,this.dSpr=_C.dSprN}cC(t){this.rgb[0]=t[0],this.rgb[1]=t[1],this.rgb[2]=t[2]}draw(){this.dSpr(this.spr,this.ind<<0)}$aC(){this.hslT?(this.hsl[0]=(this.hsl[0]+this.hslD[0]+6)%6,this.hsl[1]+=this.hslD[1],this.hsl[2]+=this.hslD[2],Res.color.y2r(this.rgb,this.hsl[0],this.hsl[1],this.hsl[2]),this.hslT--):this.rgbT&&(this.rgb[0]+=this.rgbD[0],this.rgb[1]+=this.rgbD[1],this.rgb[2]+=this.rgbD[2],this.rgbT--)}},_C.W=class extends _C.O{constructor(t,s){super(t,s),this.V=[0,0,0,0,0,0,0,0],this.B=[0,0,0,0],this.BV=[0,1,6,7],this.calc=!1}get fixedboxL(){return this.boxL+(0===this.spr.i&&this.scx<0)}cB(){this.calc||(this.calc=!0,_C.cB(this,this.w,this.h,this.fixedboxL,this.boxT,this.V,this.B,this.BV))}Bm(t,s){this.x+=t,this.y+=s;let i=this.V;for(let e=0;e<8;e+=2)i[e]+=t,i[e+1]+=s;this.B[0]=Math.round(i[this.BV[0]]),this.B[1]=Math.round(i[this.BV[1]]),this.B[2]=Math.round(i[this.BV[2]]),this.B[3]=Math.round(i[this.BV[3]])}#Tt(t,s,i,e,h,r=0,a=0){let n=h.spr,o=h.ang*Math.DR,l=Math.cos(o),d=Math.sin(o),c=h.scx,p=h.scy,u=-h.x-r+.5,m=-h.y-a+.5,f=h.ind<<0,y=h._w,v=h._h,g=h.fixedboxL,b=h.boxT;if(c>=1||p>=1)for(let h=s;h<e;h++)for(let s=t;s<i;s++){let t=Math.floor((l*(s+u)-d*(h+m))/c+g);if(t<0||t>=y)continue;let i=Math.floor((d*(s+u)+l*(h+m))/p+b);if(!(i<0||i>=v)&&n.getMask(f,t,i))return!0}if(c<1||p<1){u-=.5,m-=.5;let h=[t+u,s+m,i+u,e+m],r=y,a=v,o=0,x=0;for(let t=0;t<4;t+=2)for(let s=1;s<4;s+=2){let i=(l*h[t]-d*h[s])/c+g,e=(d*h[t]+l*h[s])/p+b;i<r&&(r=i),i>o&&(o=i),e<a&&(a=e),e>x&&(x=e)}r=Math.max(0,Math.floor(r)),a=Math.max(0,Math.floor(a)),o=Math.min(y,Math.ceil(o)),x=Math.min(v,Math.ceil(x)),g-=.5,b-=.5;for(let t=a;t<x;t++)for(let s=r;s<o;s++)if(n.getMask(f,s,t)){let i=(s-g)*c,e=(t-b)*p,r=l*i+d*e,a=l*e-d*i;if(r>=h[0]&&r<h[2]&&a>=h[1]&&a<h[3])return!0}}return!1}_meet(t,s,i,e,h,r,a){if(0===a.w||0===a.h)return!1;if(this.px||a.px){let n=Math.max(i,a.B[0]),o=Math.max(e,a.B[1]),l=Math.min(h,a.B[2]),d=Math.min(r,a.B[3]);if(!this.px&&this.ang%90==0)return this.#Tt(n,o,l,d,a);if(!a.px&&a.ang%90==0)return this.#Tt(n,o,l,d,this,t,s);let c=this.spr,p=this.ang*Math.DR,u=Math.cos(p),m=Math.sin(p),f=this.scx,y=this.scy,v=-this.x-t+.5,g=-this.y-s+.5,b=this.ind<<0,x=this._w,w=this._h,R=a.spr,M=a.ang*Math.DR,B=Math.cos(M),_=Math.sin(M),C=a.scx,k=a.scy,S=.5-a.x,T=.5-a.y,O=a.ind<<0,L=a._w,D=a._h,I=(u*v-m*g)/f+this.fixedboxL,A=(m*v+u*g)/y+this.boxT,G=(B*S-_*T)/C+a.fixedboxL,j=(_*S+B*T)/k+a.boxT;if(this.px)if(a.px)for(let t=o;t<d;t++)for(let s=n;s<l;s++){let i=Math.floor((u*s-m*t)/f+I);if(i<0||i>=x)continue;let e=Math.floor((m*s+u*t)/y+A);if(e<0||e>=w)continue;let h=Math.floor((B*s-_*t)/C+G);if(h<0||h>=L)continue;let r=Math.floor((_*s+B*t)/k+j);if(!(r<0||r>=D)&&c.getMask(b,i,e)&R.getMask(O,h,r))return!0}else for(let t=o;t<d;t++)for(let s=n;s<l;s++){let i=Math.floor((u*s-m*t)/f+I);if(i<0||i>=x)continue;let e=Math.floor((m*s+u*t)/y+A);if(e<0||e>=w)continue;let h=Math.floor((B*s-_*t)/C+G);if(h<0||h>=L)continue;let r=Math.floor((_*s+B*t)/k+j);if(!(r<0||r>=D)&&c.getMask(b,i,e))return!0}else for(let t=o;t<d;t++)for(let s=n;s<l;s++){let i=Math.floor((u*s-m*t)/f+I);if(i<0||i>=x)continue;let e=Math.floor((m*s+u*t)/y+A);if(e<0||e>=w)continue;let h=Math.floor((B*s-_*t)/C+G);if(h<0||h>=L)continue;let r=Math.floor((_*s+B*t)/k+j);if(!(r<0||r>=D)&&R.getMask(O,h,r))return!0}return!1}if(this.ang%90||a.ang%90){let i=[],e=a.V;for(let e=0;e<8;e+=2)i[e]=this.V[e]+t,i[e+1]=this.V[e+1]+s;for(let t=0;t<2;t++){for(let t=2;t<6;t+=2){let s=i[t]-i[0],h=i[t+1]-i[1],r=s*(e[0]-i[0])+h*(e[1]-i[1]),a=r;for(let t=2;t<8;t+=2){let n=s*(e[t]-i[0])+h*(e[t+1]-i[1]);n<r?r=n:n>a&&(a=n)}if(a<=0||r>=s*s+h*h)return!1}e=i,i=a.V}return!0}return!0}mp(t){return this.cB(),0===this.w||0===this.h?null:$R.Col.m(this,t)}meetAll(t){this.cB();let s=[];return 0===this.w||0===this.h||$R.Col.f(this,t,s),s}mxy(t,s,i){return this.cB(),0===this.w||0===this.h?null:$R.Col.mXY(this,i,t,s,Math.round(this.V[this.BV[0]]+t),Math.round(this.V[this.BV[1]]+s),Math.round(this.V[this.BV[2]]+t),Math.round(this.V[this.BV[3]]+s))}meetXYAll(t,s,i){this.cB();let e=[];return 0===this.w||0===this.h||$R.Col.fXY(this,i,t,s,Math.round(this.V[this.BV[0]]+t),Math.round(this.V[this.BV[1]]+s),Math.round(this.V[this.BV[2]]+t),Math.round(this.V[this.BV[3]]+s),e),e}meetOXY(t,s,i){let e=Math.round(this.V[this.BV[0]]+t),h=Math.round(this.V[this.BV[1]]+s),r=Math.round(this.V[this.BV[2]]+t),a=Math.round(this.V[this.BV[3]]+s);return!!(r>i.B[0]&&a>i.B[1]&&e<i.B[2]&&h<i.B[3]&&this._meet(t,s,e,h,r,a,i))}meetObjXY(t,s,i){let e=Math.round(this.V[this.BV[0]]+t),h=Math.round(this.V[this.BV[1]]+s),r=Math.round(this.V[this.BV[2]]+t),a=Math.round(this.V[this.BV[3]]+s);for(let n=i.length;n--;){let o=i[n];if(r>o.B[0]&&a>o.B[1]&&e<o.B[2]&&h<o.B[3]&&this._meet(t,s,e,h,r,a,o))return!0}return!1}},_C.G=class extends _C.W{constructor(t,s){super(t,s),this.xs=t,this.ys=s,this.xp=t,this.yp=s,this.Bp=[0,0,0,0],this.m_=!1,this.colS=[],this._inCol=!1,this.DEF=[],this.MOV=[],this.TML=[],this.tmlB=50,this.TRG=[[],[],[],[],[]],this.trgMap=[],this.VAR={},this.tC={},this._scx=1,this._scy=1,this.gscy=1,this.gscx=1,this.gag=0,this.step0=_C.skip,this.timer=_C.skip,this.step1=_C.skip,this.step2=_C.skip}iA(){let t=0;if(this.tml&&(this.tml.for(t=>{const s=[];s.run=t[0],s.time=0,s.node=0,s.jump=t[1].jump,this.TML.push(s),t[1].for(t=>{const i={_:t};.02===t[0]&&(i.ct=0),s.push(i)})}),this.timer=this.#Ot,this.tml._c_?.for(t=>this.colS[t]??={i:0,o:null,c:!1}),t+=this.tml._e_),this.trg){let s=0;this.trg.for(t=>{const i=[t[1]];3!==t[0]&&(this.TRG[t[0]-(t[0]>3)].push(i),s|=1<<t[0]),this.trgMap.push(i),i.ex=0}),1&s&&(this.step0=this.#Lt),2&s&&(this.step1=this.#Dt),4&s&&(this.step2=this.#It),this.trg._c_?.for(t=>this.colS[t]??={i:0,o:null,c:!1}),t+=this.trg._e_,this._E=0}if(this.ev&&(this.ev._c_?.for(t=>this.colS[t]??={i:0,o:null,c:!1}),t+=this.ev._e_),t&&(this._e=Array(t).fill(0)),this.def){const t=Lib.def[this.def];this.DEF.push(t[1]),this._m_|=t[0]}}_init(){this.px=this.spr.px,this._scx=this.scx,this._scy=this.scy,this.w=this.scx*this._w,this.h=this.scy*this._h,this.initOxy(),this.cB(),this.m_=!1;for(let t=0;t<4;t++)this.Bp[t]=this.B[t];this.$d(),this.iA(),"string"==typeof this.rgb&&(this.rgb=Lib.dec.color(this.rgb))}oC(){this.cop?.for(t=>{this.VAR[t[1]]=Lib.eE(this,t[2])}),this.TRG[3].for(t=>this.tR(t))}$d(){null!==this.spr[0]&&(this.ly.upd=!0)}initOxy(){let t=this.spr;if(this.a){let s=this.a-1;this.sprX=1&s?t.w>>1:2&s?t.w:0,this.sprY=4&s?t.h>>1:8&s?t.h:0}else this.sprX=t.x,this.sprY=t.y;this.resetBox()}resetBox(){this.boxL=this.sprX-this.spr.bL,this.boxT=this.sprY-this.spr.bT,this.maxW=1.414214*Math.max(this.boxL,this._w-this.boxL),this.maxH=1.414214*Math.max(this.boxT,this._h-this.boxT)}_cR(){if(this.or)return;let t=Math.max(Math.abs(this.maxW*this.scx),Math.abs(this.maxH*this.scy)),s=$R._r;return this.y-t>=s.h+32||this.y+t<=-32||this.x-t>=s.w+32||this.x+t<=-32}set $x(t){t!==this.x&&(this.x=t,this.$d(),this.calc=!1,this.m_=!0)}set $y(t){t!==this.y&&(this.y=t,this.$d(),this.calc=!1,this.m_=!0)}set $scx(t){this._scx=t,(t*=this.gscx)!==this.scx&&(this.scx=t,this.w=t*this._w,this.$d(),this.calc=!1,this.m_=!0)}set $scy(t){this._scy=t,(t*=this.gscy)!==this.scy&&(this.scy=t,this.h=t*this._h,this.$d(),this.calc=!1,this.m_=!0)}set $ang(t){(t=(t%360+360)%360)!==this.ang&&(this.ang=t,this.$d(),this.calc=!1,this.m_=!0)}oev(t){this._E=(this.trg?._e_??0)+(this.tml?._e_??0),this.ev[t]?.for(t=>t.f(this,t)),this._E=0}tR(t){++t.ex>999&&$R.mE(this,1,this.trgMap.indexOf(t)),t[0].for(t=>t.f(this,t)),t.ex--}#Ot(){this._E=this.trg?._e_??0;for(let t=0;t<this.TML.length;t++){const s=this.TML[t];if(s.run){let i=0;for(;s.run&&s.time<=1e-9;){const e=s[s.node++];if(!e){s.run=0,s.time=0,s.node=0;break}++i>9999&&$R.mE(this,0,t,s.node-1),e._.f(this,e._,s,e)}s.run&&s.time>0&&s.time--}}this._E=0}#Lt(){for(let t=0;t<this.TRG[0].length;t++)this.tR(this.TRG[0][t])}#Dt(){for(let t=0;t<this.TRG[1].length;t++)this.tR(this.TRG[1][t])}#It(){for(let t=0;t<this.TRG[2].length;t++)this.tR(this.TRG[2][t])}uPP(){this.xp=this.x,this.yp=this.y;for(let t=0;t<4;t++)this.Bp[t]=this.B[t]}uWU(){this.uPP();for(let t=0;t<this.TRG[2].length;t++)this.tR(this.TRG[2][t])}Md(t){this.MOV[t]&&(this.MOV[t]=null)}uCO(t,s=1){t.colS&&this.cmL.for(s=>{if(t.colS[s]&&!t.colS[s].c){let i=t.colS[s];0!==i.i&&3!==i.i||(i.i=1),i.o=this,i.c=!0}}),s&&t.uCO&&t.uCO(this,0)}uC(t){let s=this.colS[t];if(s.c)return s.i;if(0===s.i){let i=this.mp(t);i&&(s.i=1,s.o=i,this.uCO(i,0))}else if(2===s.i){let i=this.mp(t);i?this.uCO(i,0):s.i=3,s.o=i}return s.c=!0,s.i}uCS(){for(let t=this.colS.length;t--;){const s=this.colS[t];s&&(1===s.i?s.i=2:3===s.i&&(s.i=0),s.c=!1)}}wM(t,s){let i=this.mK;if(i?.length)switch(t){case 1:{let t=0;for(;t<i.length;){if(!i[t]._des){s(i[t]);break}t++}t&&i.splice(0,t);break}case 2:{let t=i.length;for(;t--;)if(!i[t]._des){s(i[t]);break}t+1<i.length&&i.splice(t+1);break}case 3:{let t=[];for(let s=0;s<i.length;s++)i[s]._des?i.splice(s--,1):t.push(s);t.length&&s(i[Math.rand(0,t.length)<<0]);break}default:for(let t=0;t<i.length;t++)i[t]._des?i.splice(t--,1):s(i[t])}}dNormal(){if(this.hd||0===this.scx||0===this.scy)return;let t=this.bm??this.spr.m;t&&$R.rr.BM(t),this.dSpr(this.spr,this.ind<<0),t&&$R.rr.BM(0)}},_C.R=class extends _C.G{constructor(t,s,i,e,h){switch(super(s,i),this.obj=t,this.dep=e,this.ly=$R.L[e],this.oid=this.ly.push(this),t){case 10:this.cB=this.calcBoxG,this.activate=this.#At,this.move=this.#Gt,this.draw=_C.skip,this.$d=_C.skip;break;case 63:this.activate=this.#jt,this.move=this.#Et,this.draw=_C.skip,this.$d=_C.skip;break;default:this.activate=this.#jt,this.spr=h,this._w=h.boxW,this._h=h.boxH,this.move=_C.skip,this.draw=null===h[0]?_C.skip:this.dNormal,this.Bc=[0,0,0,0]}this.cmL=[],this.cmI=[],this.colMov=!1,this.colli=_C.skip,this.hd=0}sSp(t){this.spr=t,this._w=t.boxW,this._h=t.boxH,this.px=this.spr.px,this.w=this.scx*this._w,this.h=this.scy*this._h,this.initOxy(),this.$d(),this.calc=!1,this.uCB(),this.spr.ims&&this.DEF[0]!==Lib.def[1][1]&&this.DEF[0]!==Lib.def[5][1]&&this.DEF.add(Lib.def[0][1])}setTile(){if(this.spr.tile&&this.spr.length>1){let t=0|this.til,s=15&t;switch(this.spr.length){case 2:this.tile=(s>7)<<0,this.draw=this.dTile;break;case 4:this.tile=t>15?0:(3==(3&s))+((12==(12&s))<<1),this.draw=this.dTile;break;case 16:this.tile=s,this.draw=this.dTile;break;default:this.tile=t,this.draw=this.dTile}}else this.draw===this.dTile&&(this.draw=null===this.spr[0]?_C.skip:this.dNormal);this.ind=this.ind%this.spr.length}sHd(t){this.hd!==t&&(this.hd=t,63===this.obj?t?this.html?._h():this.html?._s():this.$d())}pI(){switch(11===this.dep&&(this.ov=1),this.obj){case 63:this.#Pt();case 10:return this._scx=this.scx,this._scy=this.scy,void this.iA();case 11:this.draw=this.dLaser,this._h=this.lso?this.len:0;break;case 22:this.draw=this.dRope,this._h=this.len;break;case 55:this.draw=this.dHp,this._hp=-1,this.tHp=-1,this.hpt??=[],this.hct&&(this.hcf=this.hcf.slice(),this.hce=this.hce.slice(),Lib.dec.chT(this.hcf,this.hce,this.hct));break;case 62:this.spr=$R._r.Spr[this.spr.name+$R.sprPly[this.pli]]??$R._r.Spr.ply_i,this.ind=this.ind%this.spr.length;break;case 64:this.draw=this.dNum;break;default:this.setTile()}this._init()}init(t=!1){if(63!==this.obj){let s=1&this._m_,i=2&this._m_,e=4&this._m_;if(i&&(this.colMov=!0),10===this.obj)this.gpi||this.updGrp(1);else{if((this.ims??this.spr.ims)&&this.DEF[0]!==Lib.def[1][1]&&(this.DEF.push(Lib.def[0][1]),s=1),this.cm){let t=$R.cm[this.cm],s=$R.cm[this.obj+5];this.cm>=2&&t&&this.cmL.push(t),s&&this.cmL.push(s),(t||s)&&$R.Col._.add(this)}e&&(this.move=this.uCS),this.colMov?(this.move=this.#Xt,this.step2=this.TRG[2].length?this.uWU:this.uPP):s&&(this.move=e?this.#Xt:this.#Ut)}this.mov?.for(t=>t.f(this,t)),t&&(++this.ly.oCC>9999&&$R.mE(this,2),this.ly.ready&&this.ly.add(this))}this.oC()}calcBoxG(){this.calc||(this.calc=!0,this.B[0]=Math.round(this.x),this.B[1]=Math.round(this.y),this.B[2]=this.B[0],this.B[3]=this.B[1])}#jt(t,s,i,e){this.gpi||(this.B[0]<i&&this.B[1]<e&&this.B[2]>t&&this.B[3]>s||this.ov)&&this.ly.add(this)}#Ft(t,s,i,e){return!!(this.x<i&&this.y<e&&this.x>t&&this.y>s||this.ov||this.grpO.some(h=>10!==h.obj&&(h.B[0]<i&&h.B[1]<e&&h.B[2]>t&&h.B[3]>s||h.ov)))||this.grpO.some(h=>10===h.obj&&h.#Ft(t,s,i,e))}#Vt(){this.grpO.for(t=>{t.ly.add(t),10===t.obj&&t.#Vt()})}#At(t,s,i,e){this.gpi||this.#Ft(t,s,i,e)&&(this.ly.add(this),this.#Vt())}#Pt(){this.html=$R.guP(),this.html.o=this,this.html.upd=!0,_C.ST(this.html,this.css),css(this.html,{left:this.x+"px",top:this.y+"px"}),this.#Yt(this.a),this.html.style.transform=this.oT+(this.css._.transform??""),1!==this.tcs[0]&&(this.html.lastChild.style.opacity=""),this.txi=0,this.Tx(this.txs[0]),this.hd&&this.html._h(),this.html.pN.append(this.html)}#Yt(t){let s=1&t?50:2&t?100:0,i=4&t?50:8&t?100:0;this.html.style.transformOrigin=`${s}% ${i}%`,this.oT=t?`translate(${-s}%,${-i}%) `:""}Tx(t){const s=this.html.lastChild;if(this.txT=0,!t)return s.tx(""),void(this.txt="");switch(0===t[0]&&(t=t[1]),this.tcs[0]){case 0:s.tx(t),t&&this.oev(0);break;case 1:this.txT=this.txt&&!this.txT?this.tcs[1]:this.tcs[1]/2;break;case 2:t.length?this.txT=this.tcs[1]*(t.length-1)+1:s.tx(t)}this.txt=t}uCB(){10===this.obj?!this.m_||this.gpi&&this.grp.c.m_||this.updGrp():this.cmL.length&&$R.Col._.upd(this)}destroy(){if(!this._des)switch(this.TRG[4].for(t=>this.tR(t)),this._des=!0,this.$d(),this.obj){case 10:this.grpO.for(t=>{t.gpi="",t.gscx=1,t.gscy=1,t.gag=0,t._scx=t.scx,t._scy=t.scy});break;case 63:this.html.o=null,this.html._h();break;default:this.cmL.length&&$R.Col._.rm(this)}}outRoom(){this.destroy()}moveOxy(t){let s,i;t?(s=1&--t?this.spr.w>>1:2&t?this.spr.w:0,i=4&t?this.spr.h>>1:8&t?this.spr.h:0):(s=this.spr.x,i=this.spr.y);let e=this.xp-this.x,h=this.yp-this.y;_C.moveOxy(this,s,i),this.xp=this.x+e,this.yp=this.y+h,this.resetBox()}#$t(){this.outIn&&($R.colS.push(this),this.outIn=!1)}bc(){let t=0,s=0;for(let i=0;i<this.bcO.length;i++){let e=t?null:this.mxy(0,-this.v_,this.bcO[i]),h=s?null:this.mxy(-this.h_,0,this.bcO[i]);if(e&&(this.uCO(e),t=this.h_),h&&(h!==e&&this.uCO(h),s=this.v_),!e&&!h){let e=this.mp(this.bcO[i]);if(e){this.uCO(e),t=this.h_,s=this.v_;break}}}(t||s)&&(this.Bm(-2*t,-2*s),t&&s?this.$hvspd(-t,-s):t?this.$h_=-t:s&&(this.$v_=-s),this.uCB())}out(){this.outD=this.gpi||this.MOV[3]||this.MOV[4],this.outD||($R.colT.push(this),this._out())}_out(){for(let t=0;t<this.outO.length;t++){const s=this.meetAll(this.outO[t]);for(let i=0;i<s.length;i++){const e=s[i];this.uCO(e);let h=0,r=0,a=0,n=0;if(this.px||e.px||this.ang%90||e.ang%90){let t=this.B[2]-this.Bp[2]-(e.B[0]-e.Bp[0]),s=this.B[0]-this.Bp[0]-(e.B[2]-e.Bp[2]),i=0;if((t>0||0===t&&s>0)&&this.Bp[0]<e.Bp[2]&&(i=Math.max(t,s)+2.5,this.meetOXY(-i,0,e)&&(i=0)),!i&&(s<0||0===s&&t<0)&&this.Bp[2]>e.Bp[0]&&(i=Math.min(t,s)-2.5,this.meetOXY(-i,0,e)&&(i=0)),i){let t=.5,s=Math.sign(i);for(;t<s*i&&this.meetOXY(t*-s,0,e);)t+=.5;a=t*s,h=this.h_-e.h_}let o=this.B[3]-this.Bp[3]-(e.B[1]-e.Bp[1]),l=this.B[1]-this.Bp[1]-(e.B[3]-e.Bp[3]),d=0;if((o>0||0===o&&l>0)&&this.Bp[1]<e.Bp[3]&&(d=Math.max(o,l)+2.5,this.meetOXY(0,-d,e)&&(d=0)),!d&&(l<0||0===l&&o<0)&&this.Bp[3]>e.Bp[1]&&(d=Math.min(o,l)-2.5,this.meetOXY(0,-d,e)&&(d=0)),d){let t=.5,s=Math.sign(d);for(;t<s*d&&this.meetOXY(0,t*-s,e);)t+=.5;n=t*s,r=this.v_-e.v_}}else this.Bp[2]<=e.Bp[0]?(a=this.B[2]-e.B[0],h=this.h_-e.h_):this.Bp[0]>=e.Bp[2]&&(a=this.B[0]-e.B[2],h=this.h_-e.h_),this.Bp[3]<=e.Bp[1]?(n=this.B[3]-e.B[1],r=this.v_-e.v_):this.Bp[1]>=e.Bp[3]&&(n=this.B[1]-e.B[3],r=this.v_-e.v_);if(a||n||h||r){a&&n&&(this.mxy(-h,0,this.outO[t])?h=a=0:this.mxy(0,-r,this.outO[t])&&(r=n=0));let s=!1;if(e.outO&&!e.outD)for(let t=0;t<this.cmL.length;t++)if(e.outO.includes(this.cmL[t])){s=!0;break}if(a||h){let t=-a,i=-h*(1+this.outB);s&&(t/=2,i/=2),this.outX*t>0?(t-this.outX)*t>0&&(this.outX=t):this.outX+=t,this.outH*i>0?(i-this.outH)*i>0&&(this.outH=i):this.outH+=i}if(n||r){let t=-n,i=-r*(1+this.outB);s&&(t/=2,i/=2),this.outY*t>0?(t-this.outY)*t>0&&(this.outY=t):this.outY+=t,this.outV*i>0?(i-this.outV)*i>0&&(this.outV=i):this.outV+=i}this.#$t()}}}}grpOp(t){for(let s=0;s<this.grpO.length;s++){let i=this.grpO[s];i._des?this.grpO.splice(s--,1):10!==i.obj?t(i):i.grpOp(t)}}updGrp(t=0){for(let s=this.grpO.length;s--;){let i=this.grpO[s];if(i._des)this.grpO.splice(s,1);else{if(t&&(this.colMov&&!i.colMov&&(i.colMov=!0,10!==i.obj&&(i.move=i.#Xt,i.step2=i.TRG[2].length?i.uWU:i.uPP)),1&this.gmk&&(this.mK??=[],this.mK.push(i)),2&this.gmk&&(i.mK??=[],i.mK.push(this))),this.m_||t){if(this.csc&&(i.gscx=this.scx,i.gscy=this.scy,i.$scx=i._scx,i.$scy=i._scy),this.cag){let t=i.ang-i.gag;i.gag=this.ang,i.$ang=t+i.gag}i.updGrpPos()}else this._gp[i._gn].m_&&i.updGrpPos();10===i.obj?i.updGrp(t):i.cmL.length&&i.m_&&$R.Col._.upd(i)}}this.m_=!1}updGrpPos(){let t=this.grp.c,s=this.grp.p[this._gn],i=t.ang*Math.DR,e=Math.cos(i),h=Math.sin(i),r=s.x*t.scx,a=s.y*t.scy;this.$x=t.x+r*e+a*h,this.$y=t.y-r*h+a*e,s.m_=!1}resetGrpPos(){let t=this.grp,s=t.p[this._gn],i=-t.c.ang*Math.DR,e=Math.cos(i),h=Math.sin(i),r=this.x-t.c.x,a=this.y-t.c.y;s.x=(r*e+a*h)/t.c.scx,s.y=(a*e-r*h)/t.c.scy}cancelGroup(){this.grp.o.splice(this.grp.o.indexOf(this),1),this.grp.p[this._gn]=null,this.gpi="",this.gscx=1,this.gscy=1,this.gag=0,this._scx=this.scx,this._scy=this.scy}sG(){if(0===this.ind)return this.ind=1,this.$d(),$R.save(),$R.$p.ss=!1,this.ev?this.oev(0):this.ims=100,!0}#Gt(){for(let t=this.MOV.length;t--;)this.MOV[t]&&this.MOV[t](this)&&(this.MOV[t]=null);if(this.gpi){let t=this.grp.p[this._gn];for(let s=t.MOV.length;s--;)t.MOV[s]&&t.MOV[s](t)&&(t.MOV[s]=null)}}#Ut(){for(let t=this.MOV.length;t--;)this.MOV[t]&&this.MOV[t](this)&&(this.MOV[t]=null);if(this.DEF.for(t=>t(this)),this.gpi){let t=this.grp.p[this._gn];for(let s=t.MOV.length;s--;)t.MOV[s]&&t.MOV[s](t)&&(t.MOV[s]=null)}else this.m_&&(this.cmL.length?$R.Col._.upd(this):(this.cOR()&&this.outRoom(),this.m_=!1))}#Xt(){this.uCS(),this.#Ut()}#Et(){if(this.txT)if(1===this.tcs[0])this.txT===this.tcs[1]/2&&(this.html.lastChild.tx(this.txt),this.txt&&this.oev(0)),this.html.lastChild.style.opacity=Math.abs(this.txT--/this.tcs[1]*2-1);else if(--this.txT%this.tcs[1]==0){let t=this.txt.length-this.txT/this.tcs[1];this.html.lastChild.tx(this.txt.slice(0,t))," "!==this.txt[t-1]&&this.oev(0)}}dTile(){if(this.hd||0===this.scx||0===this.scy)return;let t=this.bm??this.spr.m;t&&$R.rr.BM(t),this.dSpr(this.spr,this.tile),t&&$R.rr.BM(0)}dRope(){if(this.hd||0===this.scx||0===this.scy)return;let t=this.spr,s=this.len-32,i=this.bm??t.m;for(i&&$R.rr.BM(i),$R.rr.$S(t[1],this.x,this.y,-this.sprX,s,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm);s>0;s-=32)s>=32?$R.rr.$S(t[0],this.x,this.y,-this.sprX,s-32,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm):$R.rr.$E(t[0],0,32-s,t.w,s,this.x,this.y,-this.sprX,0,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm);i&&$R.rr.BM(0)}dLaser(){if(this.hd&&!this.lso||0===this.scx||0===this.scy)return;let t=this.spr,s=this.bm??t.m;s&&$R.rr.BM(s),this.lso&&$R.rr.$S(t[1],this.x,this.y,-this.sprX,0,this.scx,this.h/t.h,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm),this.hd||$R.rr.$S(t[0],this.x,this.y,-this.sprX,0,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm),s&&$R.rr.BM(0)}dHp(){if(this.hd||0===this.scx||0===this.scy)return;const t=Math.min(this.hbw,16*this.scx,16*this.scy);if(this._hp>0){let s=this._hp*(32*this.scx-2*t),i=32*this.scy-2*t;if(s>0&&i>0){let e=(t-this.sprX*this.scx)/s,h=(t-this.sprY*this.scy)/i;$R.rr.$R(-1,this.x,this.y,e,h,s,i,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2])}}t&&$R.rr.$R(-2,this.x,this.y,-this.sprX/32,-this.sprY/32,32*this.scx,32*this.scy,this.ang,this.al,this.hbc[0],this.hbc[1],this.hbc[2],t)}updNum(){let t,s=0;switch(this.sh[0]){case 0:s=$R.counter[this.sh[1]]??0;break;case 1:s=$R.gVR(this.sh[1])??0;break;case 2:s=this.VAR[this.sh[1]]??0;break;case 3:switch(this.sh[1]){case 0:s=$R.plyX;break;case 1:s=$R.plyY;break;case 2:s=$R.$p?$R.$p.nh:0}break;case 4:s=$R.gRV(this.sh[1])??0;break;case 5:s=Lib.eE(this,this.sh[1])}switch(this.fm[0]){case 0:t=s.toString();break;case 1:t=s.toFixed(this.fm[1]);break;case 2:t=Date.cM(s);break;case 3:let i=10**this.fm[1];t=((Math.round(1e3*s*i)/10|0)/i).toFixed(this.fm[1])+"%"}if(t!==this.txt){this.txt=t;let s=0;if(this.a){let t=this.a-1,i=0;for(let t=this.txt.length;t--;)i+=this.spr.cw[this.txt[t]];1&t?s+=(i>>1)+this.fst:2&t&&(s+=i+2*this.fst)}this.sprX=s,this.$d()}}dNum(){if(this.hd||0===this.scx||0===this.scy||!this.txt)return;let t=this.bm??this.spr.m;t&&$R.rr.BM(t);let s=this.spr;for(let t=0,i=-this.sprX;t<this.txt.length;t++)$R.rr.$S(s[this.spr.ci[this.txt[t]]],this.x,this.y,i,-this.sprY,this.scx,this.scy,this.ang,this.al,this.rgb[0],this.rgb[1],this.rgb[2],this.cbm),i+=this.spr.cw[this.txt[t]];t&&$R.rr.BM(0)}},_C.GP=class extends _C.M{constructor(t,s){super(t,s),this.MOV=[],this.m_=!1,this.tC={}}set $x(t){t!==this.x&&(this.x=t,this.m_=!0)}set $y(t){t!==this.y&&(this.y=t,this.m_=!0)}Md(t){this.MOV[t]&&(this.MOV[t]=null)}},_C.Y=class extends _C.G{#zt=null;#Ht=!1;#Nt=0;constructor(t,s,i){if(super(t,s),this.spr=$R._r.Spr.ply_i,this.ly=$R.L[7],this.mS=3,this.maxVspd=9,this.jump1=-8.5,this.jump2=-7,this.grav=.4,this.ah_=0,this.ph_=0,this.pv_=0,this.oP=!1,this.oLD=!1,this.oR=null,this.meetRope=null,this.meetMov=null,this.eO={L:!0,R:!0,U:!0,D:!0,J:!0,J1:!0,J2:!0,JR:!0,z:!0,s:!0,a:!0,d:!0},this.eK=!0,this.invertLR=1,this.shoot=0,this.fz=!1,this.eKl=1,this.ss=!1,$R.initPly(this),i){switch(this.gd){case 90:this.y-=14;break;case 0:this.x+=6,this.y-=8;break;case 180:this.x-=8,this.y-=6}this.xs=this.x,this.ys=this.y,this.xp=this.x,this.yp=this.y}this.uxy(),this.dj=this.jp,this.ng=this.og,this._grav=.4,this._moveSpd=3,this._scx=1,this.state=new _C.State({ind:0,spr:this.spr,x:this.x,y:this.y,scx:this.scx,scy:this.scy,g:this.gd}),this.cmL=[0],this.cI(),this._init()}init(){this.oC(),!this.dk&&this.mp($R.cm[2])&&this.#Wt(Math.round(this.x-.5),Math.round(this.y-.5),Math.round(this.x+.5),Math.round(this.y+.5))}sxy(t,s){let i=t-this.x,e=s-this.y;(i||e)&&(this.x=this.xp+i,this.y=this.yp+e,this.cB(),this.uPP(),this.x=t,this.y=s,this.cB(),this.uxy())}uxy(){$R.plyX=this.x,$R.plyY=this.y}cB(){this.V[0]=this.V[4]=this.x+this._L,this.V[1]=this.V[3]=this.y+this._T,this.V[2]=this.V[6]=this.x+this._R,this.V[5]=this.V[7]=this.y+this._B,this.B[0]=Math.round(this.V[0]),this.B[1]=Math.round(this.V[1]),this.B[2]=Math.round(this.V[6]),this.B[3]=Math.round(this.V[7])}cI(){if(this.dk)this._w=2,this._h=2,this._T=-this.scy,this._B=this.scy,this._L=-this._scx,this._R=this._scx;else switch(this._w=11,this._h=21,this.gd){case 270:this._T=-12*this.scy,this._B=9*this.scy,this._L=-5*this._scx,this._R=6*this._scx;break;case 90:this._T=-9*this.scy,this._B=12*this.scy,this._L=-5*this._scx,this._R=6*this._scx;break;case 0:this._T=-6*this._scx,this._B=5*this._scx,this._L=-12*this.scy,this._R=9*this.scy;break;case 180:this._T=-5*this._scx,this._B=6*this._scx,this._L=-9*this.scy,this._R=12*this.scy}}setDk(t){if(t===this.dk)return;let[s,i,e,h]=this.B;this.dk=t,this.cI(),this.cB(),t||this.#Wt(s,i,e,h)}setGrav(t){if(t===this.gd)return;this.v_=0,this.ah_=0;let[s,i,e,h]=this.B,r=t%180!=this.gd%180;if(!r){switch(t){case 270:this.y+=3*this.scy;break;case 90:this.y-=3*this.scy;break;case 0:this.x+=3*this.scy;break;case 180:this.x-=3*this.scy}this.uxy()}this.gd=t,this.cI(),this.cB(),r&&this.#Wt(s,i,e,h)}setSc(t,s){let i=this._scx,e=this.scy;if(i===t&&e===s)return;let[h,r,a,n]=this.B;this._scx=t,this.scx=Math.sign(this.scx)*t,this.scy=s,this.cI(),this.cB(),(t>i||s>e)&&this.#Wt(h,r,a,n)}mxy(t,s,i){let e,h;switch(this.gd){case 270:e=t,h=s;break;case 90:e=t,h=-s;break;case 0:e=s,h=-t;break;case 180:e=-s,h=t}return $R.Col._.mXY(this,i,e,h,Math.round(this.x+e+this._L),Math.round(this.y+h+this._T),Math.round(this.x+e+this._R),Math.round(this.y+h+this._B))}meetXYAll(t,s,i){let e,h,r=[];switch(this.gd){case 270:e=t,h=s;break;case 90:e=t,h=-s;break;case 0:e=s,h=-t;break;case 180:e=-s,h=t}return $R.Col._.fXY(this,i,e,h,Math.round(this.x+e+this._L),Math.round(this.y+h+this._T),Math.round(this.x+e+this._R),Math.round(this.y+h+this._B),r),r}meetO(t,s,i,e,h,r,a){return!!(h>a.B[0]&&r>a.B[1]&&i<a.B[2]&&e<a.B[3]&&this._meet(t,s,i,e,h,r,a))}meetObj(t,s,i){let e,h;switch(this.gd){case 270:e=t,h=s;break;case 90:e=t,h=-s;break;case 0:e=s,h=-t;break;case 180:e=-s,h=t}let r=Math.round(this.x+e+this._L),a=Math.round(this.y+h+this._T),n=Math.round(this.x+e+this._R),o=Math.round(this.y+h+this._B);for(let t=i.length;t--;)if(this.meetO(e,h,r,a,n,o,i[t]))return!0;return!1}mp(t){return $R.Col._.mXY(this,t,0,0,this.B[0],this.B[1],this.B[2],this.B[3])}meetAll(t){let s=[];return $R.Col._.fXY(this,t,0,0,this.B[0],this.B[1],this.B[2],this.B[3],s),s}P(t){return!(!this.eK||!this.eO[t])&&$R.P(t)}R(t){return!(!this.eK||!this.eO[t])&&$R.R(t)}C(t){return!(!this.eK||!this.eO[t])&&$R.C(t)}com(){if(0===this.shoot&&(this.P("z")||this.cs&&this.C("z"))){$R.ev[6]=1,this.shoot=5,Au.play("st");let t={scx:1,scy:1,ang:0,...$R._r.bobj.blt},s=Math.sign(this.scx);0===this.gd?t.$v_=-16*s:180===this.gd?t.$v_=16*s:t.$h_=16*s,t.scx*=90===this.gd?-s:s,t.ang=(t.ang+this.gd+90)%360,new _C.B(this.x,this.y,t)}if(this.shoot&&this.shoot--,this.h_){let t=this.mxy(this.h_,0,$R.cm[24]);if(t&&t.outO){let s=t.hacc,i=t.vacc,e=(s*s+i*i)**.5;e&&(s/=e,i/=e);let[h,r]=this.p2o(this.h_,0),a=i*h-s*r;if(a){let e=a<0?-i:i,h=a<0?s:-s;for(let r=0;r<t.outO.length;r++)if(t.mxy(s,i,t.outO[r])){for(let s=0;s<t.outO.length;s++)if(t.mxy(e,h,t.outO[s])){e=0,h=0;break}if(e||h){this.uCO(t),e*=2,h*=2;for(let s=0;s<t.outO.length;s++)if(t.mxy(e,h,t.outO[s])){e/=2,h/=2;break}t.$hvspd(t.h_+e,t.v_+h),t.MOV[0]=Lib.mov[0],t.Md(4)}break}}}}}step(){if(this.ph_=0,this.pv_=0,this.fz)return;this.cB();let t=this.mp($R.cm[36]);t?this.grav=t.ag??.7:(t=this.mp($R.cm[35]),this.grav=t?t.ag??.2:this._grav),t=this.mp($R.cm[38]),t?this.mS=t.as??1:(t=this.mp($R.cm[37]),this.mS=t?t.as??6:this._moveSpd);let s=(this.C("R")||-this.C("L"))*this.invertLR;if(this.mp($R.cm[26])){let t=this.C("D")||-this.C("U");if(t&&(this.oLD=!0),this.oLD){if(this.spr=$R._r.Spr.ply_b,this.dj=this.jp,s&&(this.scx=this._scx*s,$R.ev[3+s]=1),this.h_=this.mS*s,this.v_=this.mS*t,t&&($R.ev[6+t]=1),this.grav=0,!this.P("J"))return this.com();this.oLD=!1,this.grav=.4,this.v_=0}}else this.oLD&&(this.oLD=!1,this.grav=.4,this.v_=0);let i=this.mp($R.cm[27]);if(i){if(!this.oR&&this.meetRope!==i){let t=((this.x-i.x)**2+(this.y-i.y)**2)**.5<<0;t>=0&&t<=i.h&&(this.oR=i,this.meetRope=i,this.RL=t)}if(this.oR){this.spr=$R._r.Spr.ply_b,this.dj=this.jp,s&&(this.scx=this._scx*s),this.grav=0,this.h_=0,this.v_=0;let t=this.C("D")||-this.C("U");if(this.RL+=this.mS*t,t&&($R.ev[6+t]=1),!(this.P("J")||this.RL<0||this.RL>this.oR.h))return this.com();this.oR=null,this.grav=.4,this.ph_=0,this.pv_=0}}else this.meetRope=null,this.oR&&(this.oR=null,this.grav=.4,this.ph_=0,this.pv_=0);let e=this.mxy(0,1,$R.cm[2]),h=0;if(!e){let t=this.mxy(-1,0,$R.cm[19])||this.mxy(1,0,$R.cm[19]);if(t){let s=(t.ang-this.gd+270)%360;h=0===s?-1:180===s?1:0,h&&(this.uCO(t),90===this.gd&&(h=-h))}}let r=this.mxy(0,1,$R.cm[10]);if(s){if(s!==h){if(h||(this.scx=this._scx*s),r){let t=this.mS*s,i=r.fra*this.mS;Math.abs(this.h_-t)<i&&(this.h_=t),this.h_<t?this.h_+=i:this.h_>t&&(this.h_-=i)}else this.h_=this.mS*s;this.spr=$R._r.Spr.ply_r,$R.ev[3+s]=1}}else{if(r){let t=r.frd*this.mS;Math.abs(this.h_-0)<t&&(this.h_=0),this.h_<0?this.h_+=t:this.h_>0&&(this.h_-=t)}else this.h_=0;this.spr=$R._r.Spr.ply_i}this.ad&&e&&(this.P("a")&&(this.h_-=1),this.P("d")&&(this.h_+=1)),this.v_>this.maxVspd&&(this.v_=this.maxVspd);let a=this.mxy(0,1,$R.cm[56])||this.mxy(0,1,$R.cm[25]);if(a){let t=a.csp*Math.sign(a.scx);if(t){20===a.obj&&(t=-t);let s=Math.abs(a.csa/a.csp),i=a.ang*Math.DR,[e,h]=this.o2p(t*Math.cos(i),-t*Math.sin(i));this.csd??=0,e>0?this.csd<e?this.csd+=Math.min(e-this.csd,s*e||Infinity):this.csd=e:e<0&&(this.csd>e?this.csd+=Math.max(e-this.csd,s*e||-Infinity):this.csd=e),this.h_+=this.csd,h>0?this.v_<h&&(this.v_+=Math.min(h-this.v_,s*h||Infinity)):h<0&&this.v_>h&&(this.v_+=Math.max(h-this.v_,s*h||-Infinity))}}else this.csd=0;this.oP&&!this.mxy(0,4,$R.cm[3])&&(this.oP=!1),this.oP||e||(this.spr=this.v_<0?$R._r.Spr.ply_j:$R._r.Spr.ply_f),this.com();let n=this.meetAll($R.cm[5]);if(this.jp&&this.P("J")&&(e||this.oP||this.mxy(0,1,$R.cm[3])||n.some(t=>16===t.obj)?this.eO.J1&&($R.ev[0]=1,this.v_=this.jump1,this.dj=this.jp,this.spr=$R._r.Spr.ply_j,Au.play("jp")):(this.dj>1||n.some(t=>17!==t.obj)||-1===this.dj)&&($R.ev[1]=1,this.v_=this.jump2,this.dj>1&&this.dj--,this.spr=$R._r.Spr.ply_j,Au.play("jp",2))),this.eO.JR&&this.v_<0&&this.R("J")&&(this.v_*=.45),n.length&&(this.v_>2&&(this.v_=2),n.some(t=>49===t.obj)&&(this.dj=this.jp)),h){if(this.v_=2,this.spr=$R._r.Spr.ply_t,this.scx=this._scx*h,(this.P("R")||-this.P("L"))*this.invertLR!==h)return this.meetMov=null;this.C("J")?(this.spr=$R._r.Spr.ply_j,this.v_=-9,this.h_=15*h,Au.play("wj"),$R.ev[3]=1):(this.spr=$R._r.Spr.ply_f,this.h_=this.mS*h),$R.ev[3+h]=1}this.meetMov=this.meetXYAll(0,2,$R.cm[2]),this.meetXYAll(0,2,$R.cm[3]).for(t=>this.meetMov.push(t))}p2o(t,s){switch(this.gd){case 270:return[t,s];case 90:return[t,-s];case 0:return[s,-t];case 180:return[-s,t]}}o2p(t,s){switch(this.gd){case 270:return[t,s];case 90:return[t,-s];case 0:return[-s,t];case 180:return[s,-t]}}platMove(t,s){switch(this.gd){case 270:this.ph_+=t,this.pv_+=s;break;case 90:this.ph_+=t,this.pv_+=-s;break;case 0:this.ph_+=-s,this.pv_+=t;break;case 180:this.ph_+=s,this.pv_+=-t}}applyMove(t,s){switch(this.gd){case 270:this.ah_=t,this.v_=s;break;case 90:this.ah_=t,this.v_=-s;break;case 0:this.ah_=-s,this.v_=t;break;case 180:this.ah_=s,this.v_=-t}}Bm(t,s){switch(this.gd){case 270:this.x+=t,this.y+=s;break;case 90:this.x+=t,this.y-=s;break;case 0:this.y-=t,this.x+=s;break;case 180:this.y+=t,this.x-=s}this.cB()}#Wt(t,s,i,e){const h=$R.cm[2];let r=this.meetAll(h);if(r.length){let a=0,n=0;r.for(h=>{let r=(this.B[2]>i&&h.B[0]>=i&&h.B[0]<this.B[2])<<3|(this.B[0]<t&&h.B[2]<=t&&h.B[2]>this.B[0])<<2|(this.B[3]>e&&h.B[1]>=e&&h.B[1]<this.B[3])<<1|(this.B[1]<s&&h.B[3]<=s&&h.B[3]>this.B[1]);a|=r,8===r?n|=8:4===r?n|=4:2===r?n|=2:1===r&&(n|=1)}),8&n&&(a&=-5),4&n&&(a&=-9),2&n&&(a&=-2),1&n&&(a&=-3),n&=a;let o=a^n,l=8&n?i-this.B[2]:4&n?t-this.B[0]:0,d=2&n?e-this.B[3]:1&n?s-this.B[1]:0;if(n&&([l,d]=this.o2p(l,d),this.Bm(l,d)),o&&this.meetObj(0,0,r)){let h=8&o?i-this.B[2]:4&o?t-this.B[0]:0,r=2&o?e-this.B[3]:1&o?s-this.B[1]:0;[h,r]=this.o2p(h,r),this.Bm(h,r),l+=h,d+=r}if(l){let t=Math.sign(-l);for(;!this.meetObj(t,0,r)&&l;)this.Bm(t,0),l+=t}if(d){let t=Math.sign(-d);for(;!this.meetObj(0,t,r)&&d;)this.Bm(0,t),d+=t}this.mp(h)&&this.Bm(-l,-d),this.uxy()}}move(){if(this.#Nt&&(this.#Nt--,this.$d()),this.alT&&(this.alT--,this.al+=this.alD,this.$d()),this.fz)return;if(this.ind=(this.ind+1/this.spr.ims)%this.spr.length,this.oR){let t=this.oR.ang*Math.DR,s=Math.sin(t),i=Math.cos(t);this.platMove(this.oR.x+this.RL*s-this.x,this.oR.y+this.RL*i-this.y)}if(this.meetMov){let t=0,s=Infinity;this.meetMov.for(i=>{if(!i._des){let[e,h]=this.o2p(i.x-i.xp,i.y-i.yp);h<s&&(s=h,t=e)}}),Number.isFinite(s)&&(this.ph_+=t,this.pv_+=s)}this.ah_>0?(this.ah_-=this.fric,this.ah_<0&&(this.ah_=0)):this.ah_<0&&(this.ah_+=this.fric,this.ah_>0&&(this.ah_=0)),this.uCS();for(let t=this.MOV.length;t--;)this.MOV[t]&&this.MOV[t](this)&&(this.MOV[t]=null);this.h_+=this.ah_,this.v_+=this.grav;let t=this.h_+this.ph_,s=this.v_+this.pv_,i=this.x,e=this.y;(t||s)&&this.Bm(t,s);const h=$R.cm[2];let r=this.meetAll(h);if(r.length){let i=0,e=0,a=0,n=0,[o,l]=this.p2o(t,s);if(r.for(t=>{if(this.Bp[2]<=t.Bp[0]&&this.B[2]>t.B[0])i=Math.max(i,o-t.B[0]+t.Bp[0]);else if(this.Bp[0]>=t.Bp[2]&&this.B[0]<t.B[2])a=Math.min(a,o-t.B[2]+t.Bp[2]);else{let s=o-t.x+t.xp;s<0?a=Math.min(a,s):s>0&&(i=Math.max(i,s))}if(this.Bp[3]<=t.Bp[1]&&this.B[3]>t.B[1])e=Math.max(e,l-t.B[1]+t.Bp[1]);else if(this.Bp[1]>=t.Bp[3]&&this.B[1]<t.B[3])n=Math.min(n,l-t.B[3]+t.Bp[3]);else{let s=l-t.y+t.yp;s<0?n=Math.min(n,s):s>0&&(e=Math.max(e,s))}this.uCO(t)}),[i,e]=this.o2p(i||a,e||n),i||e){if(this.Bm(-i,-e),i&&this.mxy(i,0,h)){for(let t=Math.sign(i),s=Math.abs(i),e=0;e<s&&!this.mxy(t,0,h);e++)this.Bm(t,0);this.ah_=0,this.h_=0,i=0}if(e&&this.mxy(0,e,h)){for(let t=Math.sign(e),s=Math.abs(e),i=0;i<s&&!this.mxy(0,t,h);i++)this.Bm(0,t);e>0?(this.dj=this.jp,this.v_=0):(this.v_-=e,this.v_<1e-12&&(this.v_=0)),e=0}(i||e)&&this.mxy(i,e,h)&&(this.ah_=0,this.h_=0,i=0),(i||e)&&this.Bm(i,e)}}let a=this.meetAll($R.cm[3]);for(let t=a.length;t--;){let s=a[t];if(this.uCO(s),s.ang%90==this.gd%90&&1!==s.pfs&&(2===s.pfs||s.ang%180==(this.gd+90)%180))switch(this.gd){case 270:{let i=s.B[1],e=this.v_-s.v_,r=Math.round(this.y+this._B-e),a=i-(this.y+this._B);if((this.y-e/2<=i||r<=i)&&!this.mxy(0,a,h)){let i=s.v_>0?s.v_:0;this.Bm(0,a),this.v_=i,this.oP=!0,this.dj=this.jp,t=0}break}case 90:{let i=s.B[3],e=-this.v_-s.v_,r=Math.round(this.y+this._T-e),a=this.y+this._T-i;if((this.y-e/2>=i||r>=i)&&!this.mxy(0,a,h)){let i=s.v_<0?-s.v_:0;this.Bm(0,a),this.v_=i,this.oP=!0,this.dj=this.jp,t=0}break}case 0:{let i=s.B[0],e=this.v_-s.h_,r=Math.round(this.x+this._R-e),a=i-(this.x+this._R);if((this.x-e/2<=i||r<=i)&&!this.mxy(0,a,h)){let i=s.h_>0?s.h_:0;this.Bm(0,a),this.v_=i,this.oP=!0,this.dj=this.jp,t=0}break}case 180:{let i=s.B[2],e=-this.v_-s.h_,r=Math.round(this.x+this._L-e),a=this.x+this._L-i;if((this.x-e/2>=i||r>=i)&&!this.mxy(0,a,h)){let i=s.h_<0?-s.h_:0;this.Bm(0,a),this.v_=i,this.oP=!0,this.dj=this.jp,t=0}break}}}if(this.oR){let t=Math.dis(this.x-this.oR.x,this.y-this.oR.y);Math.abs(t-this.RL)>=.5&&(this.RL=t)}this.ph_=-this.h_,this.pv_=-this.v_,this.platMove(this.x-i,this.y-e),Math.abs(this.ph_)<1e-12&&(this.ph_=0),Math.abs(this.pv_)<1e-12&&(this.pv_=0),this.uxy()}colli(){if(this.fz)return;const t=$R._r;switch(t.oR){case 0:break;case 3:case 4:if(this.x<0?this.x+=t.w:this.x>=t.w&&(this.x-=t.w),4===t.oR){if(this.uxy(),this.y<0||this.y>=t.h)return this.kill(0);break}case 5:if(this.y<0?this.y+=t.h:this.y>=t.h&&(this.y-=t.h),this.uxy(),5===t.oR&&(this.x<0||this.x>=t.w))return this.kill(0);break;default:if(this.x<0||this.y<0||this.x>=t.w||this.y>=t.h)return this.kill(0)}if(this.cB(),this.uxy(),!$R.god&&this.mp($R.cm[2]))return this.kill(0);if(this.eKl&&this.mp($R.cm[4])&&this.kill())return;if(this.eKl&&$R.Col.c[2].o.length&&$R.Col.c[2].m(this,0,0,this.B[0],this.B[1],this.B[2],this.B[3])&&this.kill())return;if(-1!==this.og)if(this.mp($R.cm[23])){if(--this.ng<0){if(this.eKl&&this.kill())return;this.ng=this.og}this.#Ht=!0,this.$d()}else this.ng=this.og,this.#Ht=!1;if(this.ss=!0,4&$R.saveMode&&this.eK&&$R.P("z")||1&$R.saveMode&&this.P("s")){let t=this.mp($R.cm[7]);t&&t.sG()}let s=this.mp($R.cm[6]);if(s){let t=s.wx,i=s.wy;1===s.wxt?t+=s.x:2===s.wxt&&(t+=this.x),1===s.wyt?i+=s.y:2===s.wyt&&(i+=this.y),$R.warp(s.wr,s.ws,t,i,s.wsv)}this.P("U")&&(this.#zt=this.mp($R.cm[44]),this.#zt&&$R.showBoard(this.#zt.txt)),this.#zt&&(!this.P("D")&&this.meetO(0,0,this.B[0],this.B[1],this.B[2],this.B[3],this.#zt)||($R.closeBoard(),this.#zt=null));const i=this.state;i.ind=this.ind<<0,i.spr=this.spr,i.x=this.x,i.y=this.y,i.scx=this.scx,i.scy=this.scy,i.g=this.gd,i.$d()&&this.$d(),this.uPP()}destroy(){this._des||(this.TRG[4].for(t=>this.tR(t)),this._des=!0,this.$d(),$R.$p=null)}kill(t=1){if(t&&($R.god||this.#Nt||0===this.mh))return;if(Au.play("dth"),$R.ev[9]=1,t&&(this.nh-=t,this.nh>0))return void(this.#Nt=this.hpt);let s=new _C.R(0,400,304,11,$R._r.sprGO);return Object.assign(s,$R._r.bobj.gov),s.cm=0,s.pI(),s.init(!0),$R.addDth(),$R.ev[8]=1,this.destroy(),App.gC("run","pause")&&$R.bgm.fO(1),!0}sHd(t){this.hd=t}static dPl(t,s,i,e,h,r,a,n,o,l,d){if(a){const{dkc:e,dks:h}=$R._r.bobj.ply;let a=Math.round(t),d=Math.round(s),c=e[0]*l[0],p=e[1]*l[1],u=e[2]*l[2];$R.rr.$R(-1,a,d,-.5,-.5,2*n,2*o,i-270,r,c,p,u),h[0]<2&&$R.rr.$R(2*h[0]-4,a,d,-.5,-.5,h[1],h[1],0,r,c,p,u)}else $R.rr.$S(e[h<<0],t,s,-e.x,-e.y,90===i?-n:n,o,i-270,r,l[0],l[1],l[2],d)}draw(){if(this.hd)return;let t=this.al*(1-.3*(0|$R.god));if(t&&(this.bm&&$R.rr.BM(this.bm),_C.Y.dPl(this.x,this.y,this.gd,this.spr,this.ind,t,this.dk,this.scx,this.scy,this.rgb,this.cbm),this.bm&&$R.rr.BM(0)),this.#Ht){if(this.oal&&-1!==this.og){let t=this.ng/this.og,s=[];Res.color.hT(s,this.ocf,this.oce,t,this.oct),_C.dHp(t,this.x,this.y,-32,this.gd-270,this.ogw,this.ogh,s[0],s[1],s[2],this.oal,this.obc[0],this.obc[1],this.obc[2],this.obw)}}else if(this.#Nt&&this.mh&&this.hal){let t=Math.min(1,this.#Nt/this.hpt*3)*this.hal,s=this.nh/this.mh,i=[];Res.color.hT(i,this.hcf,this.hce,s,this.hct),_C.dHp(s,this.x,this.y,-32,this.gd-270,this.hpw,this.hph,i[0],i[1],i[2],t,this.hbc[0],this.hbc[1],this.hbc[2],this.hbw)}}},_C.B=class extends _C.G{constructor(t,s,i){super(t,s),this.spr=$R._r.Spr.blt,this.ly=$R.L[7],this._w=this.spr.boxW,this._h=this.spr.boxH,this.cmL=[1],this.hd=0,this.draw=this.dNormal,this.uCB=_C.skip,Object.assign(this,i),this._init(),$R.Col.c[1].o.push(this),this.MOV[0]=Lib.mov[0],this.mov?.for(t=>t.f(this,t)),this.oC()}sHd(t){this.hd=t}destroy(){this._des||(this.TRG[4].for(t=>this.tR(t)),this._des=!0)}meetDes(t){let s=this.mp(t);s&&(this.uCO(s),this.destroy())}move(){this.uCS();for(let t=this.MOV.length;t--;)this.MOV[t]&&this.MOV[t](this)&&(this.MOV[t]=null);let t=this.ims??this.spr.ims;t&&(this.ind=(this.ind+1/t+this.spr.length)%this.spr.length),this.$d(),this.cB(),this.cOR()&&this.destroy(),this.uPP()}colli(){if(!this._des&&$R.$p&&2&$R.saveMode&&$R.$p.ss){let t=this.mp($R.cm[7]);t&&t.sG()&&(this.uCO(t),this.destroy())}}},_C.P=class extends _C.O{constructor(t,s,i,e=7,h=!0){super(t,s),this.spr=i,this.sprX=i.w>>1,this.sprY=i.h>>1,this._sM=1.414214*Math.max(this.sprX,this.sprY),i.m&&(this.dSpr=_C.dSprB),this.dep=e,h&&$R.L[e].e.push(this),this.rot=0,this.dspd=0,this.aspd=0,this.xspd=0,this.yspd=0,this.scxA=1,this.scyA=1,this.dM=0}#Kt=0;move(t){if(this.afi&&void 0===this.alT&&(this.alT=this.al,this.al=0),this.shadow&&this.#Kt++%this.shadow[0]==0&&this.scx&&this.scy&&this.al){let s=new _C.P(this.x,this.y,this.spr,this.dep,!1);s.sF(this),s.lw=this.lw,s.ptc=this.ptc,$R.L[this.dep].e.insert(s,t)}if(this.ims&&this.spr[0]>=0&&(this.ind+=1/this.ims,this.ind>=this.spr.length?this.ind-=this.spr.length:this.ind<0&&(this.ind+=this.spr.length)),this.$aA(),this.x+=this.h_,this.y+=this.v_,this.afi)this.al+=this.afi,this.al>=this.alT&&(this.al=this.alT,this.afi=0);else if(this.aspd&&(this.al-=this.aspd,this.al<=0))return $R.L[this.dep].e.remove(t),!0;if(this.scx+=this.xspd*this.scxA,this.scy+=this.yspd*this.scyA,this.scx*this.scxA<=0||this.scy*this.scyA<=0)return $R.L[this.dep].e.remove(t),!0;let s=this._sM*Math.max(this.scx*this.scxA,this.scy*this.scyA)+this.dM;if($R.L[this.dep].iG()){if(this.x<-s||this.y<-s||this.x>800+s||this.y>608+s)return $R.L[this.dep].e.remove(t),!0}else{if(this.x<$R.view.L-s||this.y<$R.view.T-s||this.x>$R.view.R+s||this.y>$R.view.B+s)return $R.L[this.dep].e.remove(t),!0;this.sld&&$R.Col._.mP(this.x,this.y,$R.cm[2])&&(this.sld=!1,this.$spd=0,this.hacc=0,this.vacc=0,this.acc=0)}this.ang+=this.rot,this.$dir=this.dir+this.dspd,this.$aC()}sF(t){this.ind=t.ind,this.scx=t.scx,this.scy=t.scy,this.ang=t.ang,this.al=t.al*t.shadow[1],this.aspd=t.shadow[2],this.xspd=t.shadow[3],this.yspd=t.shadow[3],this.bm=t.bm,this.cbm=t.cbm,this.dSpr=t.dSpr,this.cC(t.rgb)}static from(t,s=0){if(!s&&(null===t.spr[0]||11!==t.obj&&t.hd||11===t.obj&&t.hd&&!t.lso))return;let i=new _C.P(t.x,t.y,t.spr,t.dep),e=i.sprX,h=i.sprY;return i.ind=t.ind<<0,i.scx=t.scx,i.scy=t.scy,i.sprX=t.sprX,i.sprY=t.sprY,i.cC(t.rgb),i.bm=t.bm,i.cbm=t.cbm,t.kill?(i.ang=(t.gd+90)%360,t.dk?(i.cC(t.dkc),i.scx=t.scx/16,i.scy=t.scy/16,i.spr=$R.shS,i.ind=0,i.sprX=16,i.sprY=16,i._sM=22.63):180===i.ang&&(i.scy=-i.scy,i.scyA=-i.scyA,i.ang=0),i.bm&&(i.dSpr=_C.dSprB)):(i.ang=t.ang,i.draw=t.draw,_C.moveOxy(i,e,h),11===t.obj?(i.lso=t.lso,i.h=t.h):22===t.obj?i.len=t.len:54===t.obj?i.lw=t.lw:void 0!==t.tile&&(i.tile=t.tile)),i.scx<0&&(i.scxA=-1),i.scy<0&&(i.scyA=-1),i}},_C.D=class extends _C.W{constructor(t,s,i){super(t,s),this.#Jt(i[0]),this.ind=i[1],this.rot=0,this.dspd=0,this.spdT=0,this.wH=0,this.wV=0,this.dM=0,this.kill=1}#Jt(t){this.spr=t,this.px=t.px,this._w=t.boxW,this._h=t.boxH,this.sprX=t.w>>1,this.sprY=t.h>>1,this.boxL=this.sprX-t.bL,this.boxT=this.sprY-t.bT,t.m&&void 0===this.bm&&(this.dSpr=_C.dSprB)}sSp(t){let[s,i]=t;this.spr!==s&&(this.#Jt(s),this.w=this.scx*this._w,this.h=this.scy*this._h,this.calc=!1,this.cB()),this.ind=i}init(t){$R.Col.c[2].o.length>65535&&$R.tE("max barrage count exceeded","错误提示：弹幕数量达到上限"),this.w=this.scx*this._w,this.h=this.scy*this._h,this.cB(),$R.Col.c[2].o.push(this),this.emt=t,this.grp=t.grp,this.xs=this.x,this.ys=this.y,this.xp=this.x,this.yp=this.y}#Kt=0;move(){if(this.afi&&void 0===this.alT&&(this.alT=this.al,this.al=0,this.afiK&&(this.kill=0)),this.shadow&&this.#Kt++%this.shadow[0]==0&&this.scx&&this.scy&&this.al&&new _C.P(this.x,this.y,this.spr).sF(this),this.ims&&(this.ind+=1/this.ims,this.ind>=this.spr.length?this.ind-=this.spr.length:this.ind<0&&(this.ind+=this.spr.length)),this.spdT>0?(this.$spd=this.spd+this.spdD*Math.min(this.spdT,1),this.spdT--):this.$aA(),this.xp=this.x,this.yp=this.y,this.bc&&this.bcC){let t=$R.cm[2],s=!0;this.mxy(this.h_,0,t)&&(this.$h_=-this.h_,s=!1),this.mxy(0,this.v_,t)&&(this.$v_=-this.v_,s=!1),s?this.mxy(this.h_,this.v_,t)&&(this.$hvspd(-this.h_,-this.v_),this.bcC--):this.bcC--}let t=this.h_,s=this.v_,i=!1;if(this.c&&!this.c._des&&(t+=this.c.x-this.c.xp,s+=this.c.y-this.c.yp),this.aAD){let t=(this.dir+this.dspd+this.aAD+359)%360;t!==this.ang&&(this.ang=t,i=!0)}else this.rot&&(this.ang+=this.rot,i=!0);if(this.scxT&&(this.scxT.S--,this.scxT.S>0?this.scxT.U():(this.scxT.E(),this.scxT=null),this.w=this._w*this.scx,i=!0),this.scyT&&(this.scyT.S--,this.scyT.S>0?this.scyT.U():(this.scyT.E(),this.scyT=null),this.h=this._h*this.scy,i=!0),this.wH){let s=this.x+t,i=this.wL,e=this.wR;0===this.wC?e+=$R._r.w:1===this.wC&&(i+=$R.view.L,e+=$R.view.R),s<i?t+=e-i:s>=e&&(t-=e-i)}if(this.wV){let t=this.y+s,i=this.wT,e=this.wB;0===this.wC?e+=$R._r.h:1===this.wC&&(i+=$R.view.T,e+=$R.view.B),t<i?s+=e-i:t>=e&&(s-=e-i)}if(i?(this.x+=t,this.y+=s,this.calc=!1,this.cB()):(t||s)&&this.Bm(t,s),!this.wV&&(this.B[1]>$R.view.B+this.dM||this.B[3]<$R.view.T-this.dM)||!this.wH&&(this.B[0]>$R.view.R+this.dM||this.B[2]<$R.view.L-this.dM))this._des=!0;else{if(this.$dir=this.dir+this.dspd,this.afi)this.al+=this.afi,this.al>=this.alT&&(this.al=this.alT,this.afi=0,this.alT=void 0,this.afiK&&(this.kill=1));else if(this.aspd&&(this.al-=this.aspd,this.al<=0)){if(this.afoD)return void(this._des=!0);this.aspd=0}this.$aC()}}mR(t,s,i){this.hacc=0,this.vacc=0,this.acc=0,this.spdT=0;let e=this.x-t,h=this.y-s;if(e||h){this.dspd=i;let t=(e*e+h*h)**.5,s=-Math.atan(h/e)/Math.DR;s=(e<0?s+270:s+90)%360,s+=i/2,i<0&&(i=-i,s+=180),this.$Sd(2*Math.sin(i/2*Math.DR)*t,s)}}mZ(t,s,i){this.hacc=0,this.vacc=0,this.acc=0,this.dspd=0,this.spdT=0,this.$hvspd((this.x-t)*i,(this.y-s)*i)}tSP(t,s){this.hacc=0,this.vacc=0,this.acc=0,this.dspd=0,this.spdT=t,this.spdD=s}static circle(t,s,i,e=0){let h=360/s;for(let r=0;r<s;r++){let s=e+r*h,a=s*Math.DR;t(Math.cos(a)*i,-Math.sin(a)*i,s)}}static polygon(t,s,i,e,h=0){let r=h*Math.DR,a=360/s,n=Math.cos(r)*e,o=-Math.sin(r)*e,l=Math.sin(a/2*Math.DR)*e*2/i;for(let e=0;e<s;e++){let s=90+h+(e+.5)*a,r=s*Math.DR,d=Math.cos(r)*l,c=Math.sin(r)*l;for(let e=0;e<i;e++)t(n,o,s),n+=d,o-=c}}static emit(t,s,i,e=((t,s,i)=>new _C.D(t,s,i))){if(s.for(s=>Lib.act[6][Math.round(100*s[0]%100-1)](t,s)),i.for(s=>Lib.act[6][Math.round(100*s[0]%100-1)](t,s)),t.c?.(),$R.eC.p[1]=t.n,t.shape&&t.n>1){let s=0;switch(t.shape[0]){case 0:_C.D.circle((i,h,r)=>{$R.eC.p[0]=s;let a=e(t.x,t.y,t.spr(s));a.h_=i,a.v_=h,a.dir=r,a.spd=t.spd,t.f.for(t=>t(a,s)),s++},t.n,t.spd,t.dir);break;case 1:let i=t.shape[1],h=Math.ceil(t.n/t.shape[1]);$R.eC.p[1]=i*h,_C.D.polygon((i,h)=>{$R.eC.p[0]=s;let r=e(t.x,t.y,t.spr(s));r.$hvspd(i,h),t.f.for(t=>t(r,s)),s++},i,h,t.spd,t.dir);break;case 2:let r=(1-t.shape[1])/(t.n-1);for(let s=0;s<t.n;s++){$R.eC.p[0]=s;let i=e(t.x,t.y,t.spr(s)),h=t.spd*(t.shape[1]+r*s),a=t.dir;h<0&&(h=-h,a+=180),i.$Sd(h,a),t.f.for(t=>t(i,s))}break;case 3:let a=t.spd*t.shape[1],n=2*a/(t.n-1+t.shape[2]);for(let s=0;s<t.n;s++){$R.eC.p[0]=s;let i=e(t.x,t.y,t.spr(s));i.$hvspd(t.spd,n*s-a),i.$dir=i.dir+t.dir,t.f.for(t=>t(i,s))}break;case 4:let o=(t.dir+90)*Math.DR,l=Math.cos(o),d=-Math.sin(o),c=t.x-t.shape[1]/2*l,p=t.y-t.shape[1]/2*d,u=t.shape[1]/(t.n-1),m=u*d;u*=l;for(let s=0;s<t.n;s++){$R.eC.p[0]=s;let i=e(c,p,t.spr(s));i.$Sd(t.spd,t.dir),t.f.for(t=>t(i,s)),c+=u,p+=m}break;case 5:let f=t.dir-t.shape[1]/2,y=t.shape[1]/(t.n-1);for(let s=0;s<t.n;s++){$R.eC.p[0]=s;let i=e(t.x,t.y,t.spr(s));i.$Sd(t.spd,f+y*s),t.f.for(t=>t(i,s))}break;case 6:{let s=Math.ceil(t.n/t.shape[1]/2),i=Math.PI/t.shape[1],h=t.shape[2]/100*t.spd,r=(Math.cos(i)*h-t.spd)/s,a=Math.sin(i)*h/s,n=360/t.shape[1];$R.eC.p[1]=s*t.shape[1]*2;for(let i=0;i<t.shape[1];i--)for(let h=0;h<2;h++){for(let o=1;o<=s;o++){let l=(2*i+h)*s+o-1;$R.eC.p[0]=l;let d=e(t.x,t.y,t.spr(l));d.$hvspd(t.spd+r*((s-2*o)*h+o),a*(s*h-o)),d.$dir=d.dir+n*i+t.dir,t.f.for(t=>t(d,l))}i++}break}case 7:{let s=t.dir*Math.DR,i=Math.cos(s)*t.spd,h=Math.sin(s)*t.spd,r=Math.ceil(t.n/5),a=1.902113032590307*t.spd/r;s+=2.827433388230814,$R.eC.p[1]=5*r;for(let n=0;n<5;n++){let o=Math.cos(s)*a,l=Math.sin(s)*a;for(let s=0;s<r;s++){let a=n*r+s;$R.eC.p[0]=a;let d=e(t.x,t.y,t.spr(a));d.$hvspd(i,-h),t.f.for(t=>t(d,a)),i+=o,h+=l}s+=2.5132741228718345}break}case 8:{let s=t=>.6354578628600223*t**1+4.752386576888154*t**2-10.763980761313631*t**3+9.199976244413238*t**4-2.8238399228477844*t**5;for(let i=0;i<t.n;i++){$R.eC.p[0]=i;let h=2*i/t.n-1,r=h<0?-s(-h):s(h),a=Math.abs(r),n=(1-a)*(1+3*a),o=e(t.x,t.y,t.spr(i));o.$Sd(t.spd*n*Math.SQRT2,r/Math.DR+360),o.$hvspd(o.h_-1.0625*t.spd,1.11807481*o.v_),o.$dir=o.dir+t.dir+90,t.f.for(t=>t(o,i))}break}case 9:{let s=t=>7.285169306370282+1.9*t**.5-12*(.5-t)**.72-8.316035906366*t-4.700690714347018*t**3-23.70632831561569*t**5;for(let i=0;i<t.n;i++){$R.eC.p[0]=i;let h=i/t.n,r=h<.5?s(h):Math.PI2-s(1-h),a=Math.sin(r)**3,n=13*Math.cos(r)-5*Math.cos(2*r)-2*Math.cos(3*r)-Math.cos(4*r),o=e(t.x,t.y,t.spr(i));o.$hvspd(t.spd*a,t.spd*n/16),o.$dir=o.dir+t.dir+180,t.f.for(t=>t(o,i))}break}}}else for(let s=0;s<t.n;s++){$R.eC.p[0]=s;let i=e(t.x,t.y,t.spr(s));i.$Sd(t.spd,t.dir),t.f.for(t=>t(i,s))}}static select(t,s){let i=$R.Col.c[2].o,e=[],h=t[1]<0?i=>i.emt._o===s&&i.grp===t[1]&&!i._des:s=>s.grp===t[1]&&!s._des;switch(t[0]){case 0:for(let t=0;t<i.length;t++)h(i[t])&&e.push(i[t]);break;case 1:{let s=0;for(let r=0;r<i.length;r++)if(h(i[r])){let h=(s++-t[3])/t[2];h>=0&&h===h<<0&&e.push(i[r])}break}case 2:{let s=0;for(let r=0;r<i.length;r++)if(h(i[r]))if(s++<t[2])e.push(i[r]);else{let h=Math.rand(0,s)<<0;h<t[2]&&(e[h]=i[r])}break}case 3:h=t[1]<0?t=>t.emt._o===s&&!t._des:t=>!t._des;for(let t=0;t<i.length;t++)h(i[t])&&e.push(i[t])}return e}};const $C={key:{f2:113,p:80},setKey(){let t=App.config.key;for(let s in t)this.key[s]=t[s][0]},rec:{J:"J",L:"L",U:"U",R:"R",D:"D",a:"a",d:"d",s:"s",w:"w",x:"x",z:"z"},kD:[],kU:[],kO:[],kC(t){this.kD[t]=!1,this.kU[t]=!1},kP(t){this.kO[t]&&(this.kO[t]=!1,this.kU[t]=!0),this.kD[t]=!1},kR(t){this.kO[t]=!1,this.kU[t]=!1,this.kD[t]=!1},kCA(){for(let t in this.key)this.kC(this.key[t])},kPA(){for(let t in this.key)this.kP(this.key[t])},kRA(){for(let t in this.key)this.kR(this.key[t])},C(t){return this.kO[this.key[t]]||this.kD[this.key[t]]},P(t){return this.kD[this.key[t]]},R(t){return this.kU[this.key[t]]},opV:()=>[UI.span(`${i18n(102,0)}`),UI.Bar(150,App.gC("run","vol")/100,1,"var(--cbtl)").in(t=>Au.setVol(100*t)).on(t=>App.sC("run","vol",Math.round(100*t))),El("br"),UI.span(`${i18n(103,0)}`),UI.Bar(150,App.gC("run","bgm")/200,1,"var(--cbtl)",.5).in(t=>Au.setBgmVol(200*t)).on(t=>App.sC("run","bgm",Math.round(200*t))),UI.S(`${i18n(104,0)}`,App.gC("run","pause")).on(t=>App.sC("run","pause",t))],opK(){const t=El("div");return css(t,{display:"grid",gridTemplateColumns:"50% 50%",textAlign:"right"}),t._c(...[`${i18n(105,0)}:L`,`${i18n(106,0)}:R`,`${i18n(107,0)}:U`,`${i18n(108,0)}:D`,`${i18n(109,0)}(Shift):J`,`${i18n(110,0)}(Z):z`,"W:w","A:a","S:s","D:d","X:x",`${i18n(111,0)}(R):r`].map(t=>{let[s,i]=t.split(":");return UI.KB(s,App.gC("key",i)).on(t=>{App.sC("key",i,t),$C.setKey()})}))},opS(t){let s=["0.2x","0.5x","1.0x","2.0x","4.0x"],i=UI.span("1.0x"),e=UI.C(t,0,...s).on(t=>{let h=s[t];i.tx(h),$R.spd=e.spd=20/h.slice(0,-1)});return e.set(2),e.upd=t=>{let h=(20/t).toFixed(1)+"x";i.tx(h),e.set(s.indexOf(h)),e.spd=t},e.id="spd",El("div","btn2 hover ib rl")._c(i,El("div","pointer up")._c(El("div")._c(e)))}};$C.setKey(),doc.onkeydown=t=>{const s=t.keyCode;if(9===s)return t.preventDefault();const i=doc.activeElement.tagName;if("TEXTAREA"!==i&&"INPUT"!==i&&(s>=37&&s<=40&&t.preventDefault(),!t.repeat&&!t.ctrlKey)){if(80===s)return $R?.pause();$C.kO[s]||($C.kD[s]=!0,$C.kO[s]=!0),$R?.run||($C.kU[s]=!1)}},doc.onkeyup=t=>{const s=t.keyCode;t.ctrlKey&&!$C.kO[s]||($C.kU[s]=!0,$C.kO[s]=!1,$R?.run||($C.kD[s]=!1))},window.onblur=()=>$C.kPA(),doc.oncontextmenu=t=>t.preventDefault(),doc.onwheel=t=>{if(t.ctrlKey&&$R?.run){const s=[5,10,20,40,100];let i=s[Math.mM(s.indexOf($R.spd)-Math.sign(t.wheelDelta),0,s.length-1)];$R.spd=i,$("spd")?.upd(i)}},doc.onmousedown=t=>{if($R){if(doc.igI())return;let s;if(0===t.button?s="l":2===t.button&&(s="r"),s){let s=$("screen"),i=t.x/doc.zoom-s.left,e=t.y/doc.zoom-s.top;i>=0&&i<800&&e>=0&&e<608&&t.ctrlKey&&0===t.button&&$R.dragPly(i,e)}}},Math.PI2=2*Math.PI,Math.DR=Math.PI/180,Math.rA=9301,Math.rB=49297,Math.rC=2**32,Math.randomr=(t,s)=>t===s?t:Math.random()*(s-t)+t,Math.rand=(t,s)=>t===s?t:(_C.$R.rS=(_C.$R.rS*Math.rA+Math.rB)%Math.rC,_C.$R.rS/Math.rC*(s-t)+t),Math.randS=function(){return this.random()*this.rC+performance.now()>>>0},Math.comp=(t,s,i)=>{switch(s){case 0:return t===i;case 1:return t>i;case 2:return t<i;case 3:return t>=i;case 4:return t<=i;case 5:return t!==i}},Math.dis=(t,s)=>(t*t+s*s)**.5,Math.dir=function(t,s){if(t||s){let i=-this.atan(s/t)/this.DR;return(t<0?i+180:i+360)%360}return 0},Math.snap=function(t,s){return this.floor(t/s)*s},Object.freeze(Math);